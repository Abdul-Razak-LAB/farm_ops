{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/errors.ts"],"sourcesContent":["export class AppError extends Error {\r\n  public code: string;\r\n  public status: number;\r\n  public details?: any;\r\n\r\n  constructor(code: string, message: string, status: number = 400, details?: any) {\r\n    super(message);\r\n    this.name = 'AppError';\r\n    this.code = code;\r\n    this.status = status;\r\n    this.details = details;\r\n  }\r\n}\r\n\r\nexport function createErrorResponse(error: any) {\r\n  if (error instanceof AppError) {\r\n    return Response.json(\r\n      { success: false, error: { code: error.code, message: error.message, details: error.details } },\r\n      { status: error.status }\r\n    );\r\n  }\r\n\r\n  if (error?.name === 'ZodError') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: 'VALIDATION_ERROR',\r\n          message: 'Invalid request payload',\r\n          details: error.issues ?? error.errors,\r\n        },\r\n      },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  if (error?.code === 'P2002') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: 'CONFLICT',\r\n          message: 'A record with the same unique value already exists',\r\n          details: error.meta,\r\n        },\r\n      },\r\n      { status: 409 }\r\n    );\r\n  }\r\n\r\n  if (error?.code === 'P2003') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: 'RELATION_ERROR',\r\n          message: 'Related record is missing or invalid',\r\n          details: error.meta,\r\n        },\r\n      },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  console.error('[Unhandled Error]:', error);\r\n  return Response.json(\r\n    { success: false, error: { code: 'INTERNAL_ERROR', message: 'An unexpected error occurred' } },\r\n    { status: 500 }\r\n  );\r\n}\r\n"],"names":["AppError","Error","code","status","details","message","name","createErrorResponse","error","Response","json","success","issues","errors","meta","console"],"mappings":";;;;;;AAAO,MAAMA,iBAAiBC;IACrBC,KAAa;IACbC,OAAe;IACfC,QAAc;IAErBJ,YAAYE,IAAY,EAAEG,OAAe,EAAEF,SAAiB,GAAG,EAAEC,OAAa,CAAE;QAC9E,KAAK,CAACC;QACN,IAAI,CAACC,IAAI,GAAG;QACZ,IAAI,CAACJ,IAAI,GAAGA;QACZ,IAAI,CAACC,MAAM,GAAGA;QACd,IAAI,CAACC,OAAO,GAAGA;IACjB;AACF;AAEO,SAASG,oBAAoBC,KAAU;IAC5C,IAAIA,iBAAiBR,UAAU;QAC7B,OAAOS,SAASC,IAAI,CAClB;YAAEC,SAAS;YAAOH,OAAO;gBAAEN,MAAMM,MAAMN,IAAI;gBAAEG,SAASG,MAAMH,OAAO;gBAAED,SAASI,MAAMJ,OAAO;YAAC;QAAE,GAC9F;YAAED,QAAQK,MAAML,MAAM;QAAC;IAE3B;IAEA,IAAIK,OAAOF,SAAS,YAAY;QAC9B,OAAOG,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAM;gBACNG,SAAS;gBACTD,SAASI,MAAMI,MAAM,IAAIJ,MAAMK,MAAM;YACvC;QACF,GACA;YAAEV,QAAQ;QAAI;IAElB;IAEA,IAAIK,OAAON,SAAS,SAAS;QAC3B,OAAOO,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAM;gBACNG,SAAS;gBACTD,SAASI,MAAMM,IAAI;YACrB;QACF,GACA;YAAEX,QAAQ;QAAI;IAElB;IAEA,IAAIK,OAAON,SAAS,SAAS;QAC3B,OAAOO,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAM;gBACNG,SAAS;gBACTD,SAASI,MAAMM,IAAI;YACrB;QACF,GACA;YAAEX,QAAQ;QAAI;IAElB;IAEAY,QAAQP,KAAK,CAAC,sBAAsBA;IACpC,OAAOC,SAASC,IAAI,CAClB;QAAEC,SAAS;QAAOH,OAAO;YAAEN,MAAM;YAAkBG,SAAS;QAA+B;IAAE,GAC7F;QAAEF,QAAQ;IAAI;AAElB"}},
    {"offset": {"line": 122, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\n\r\nconst globalForPrisma = globalThis as unknown as { prisma: PrismaClient };\r\n\r\nexport const prisma = globalForPrisma.prisma || new PrismaClient();\r\n\r\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\r\n"],"names":["globalForPrisma","globalThis","prisma"],"mappings":";;;;AAAA;;AAEA,MAAMA,kBAAkBC;AAEjB,MAAMC,SAASF,gBAAgBE,MAAM,IAAI,IAAI,sMAAY;AAEhE,wCAA2CF,gBAAgBE,MAAM,GAAGA"}},
    {"offset": {"line": 135, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/permissions.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { AppError } from './errors';\r\n\r\nexport type FarmPermission =\r\n  | 'updates:read'\r\n  | 'updates:write'\r\n  | 'digest:read'\r\n  | 'monitoring:read'\r\n  | 'monitoring:write'\r\n  | 'incident:read'\r\n  | 'incident:write'\r\n  | 'vendor:read'\r\n  | 'vendor:write'\r\n  | 'procurement:read'\r\n  | 'procurement:write'\r\n  | 'payroll:read'\r\n  | 'payroll:write'\r\n  | 'payroll:approve'\r\n  | 'payroll:pay';\r\n\r\ntype FarmRole = 'OWNER' | 'MANAGER' | 'WORKER';\r\n\r\nconst roleMatrix: Record<FarmRole, FarmPermission[]> = {\r\n  OWNER: [\r\n    'updates:read',\r\n    'updates:write',\r\n    'digest:read',\r\n    'monitoring:read',\r\n    'monitoring:write',\r\n    'incident:read',\r\n    'incident:write',\r\n    'vendor:read',\r\n    'vendor:write',\r\n    'procurement:read',\r\n    'procurement:write',\r\n    'payroll:read',\r\n    'payroll:write',\r\n    'payroll:approve',\r\n    'payroll:pay',\r\n  ],\r\n  MANAGER: [\r\n    'updates:read',\r\n    'updates:write',\r\n    'digest:read',\r\n    'monitoring:read',\r\n    'monitoring:write',\r\n    'incident:read',\r\n    'incident:write',\r\n    'vendor:read',\r\n    'vendor:write',\r\n    'procurement:read',\r\n    'procurement:write',\r\n    'payroll:read',\r\n    'payroll:write',\r\n  ],\r\n  WORKER: ['updates:read', 'updates:write', 'incident:read', 'incident:write', 'procurement:read'],\r\n};\r\n\r\nexport function getRequestRole(request: NextRequest): FarmRole {\r\n  const headerRole = request.headers.get('x-farm-role');\r\n  if (headerRole === 'OWNER' || headerRole === 'MANAGER' || headerRole === 'WORKER') {\r\n    return headerRole;\r\n  }\r\n\r\n  return 'MANAGER';\r\n}\r\n\r\nexport function getRequestUserId(request: NextRequest): string {\r\n  return request.headers.get('x-user-id') || 'user_id_from_session';\r\n}\r\n\r\nexport function requirePermission(request: NextRequest, permission: FarmPermission) {\r\n  const role = getRequestRole(request);\r\n  if (!roleMatrix[role].includes(permission)) {\r\n    throw new AppError('FORBIDDEN', 'You do not have permission for this action', 403);\r\n  }\r\n}\r\n"],"names":["roleMatrix","OWNER","MANAGER","WORKER","getRequestRole","request","headerRole","headers","get","getRequestUserId","requirePermission","permission","role","includes"],"mappings":";;;;;;;;AACA;;AAqBA,MAAMA,aAAiD;IACrDC,OAAO;QACL;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACDC,SAAS;QACP;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACDC,QAAQ;QAAC;QAAgB;QAAiB;QAAiB;QAAkB;KAAmB;AAClG;AAEO,SAASC,eAAeC,OAAoB;IACjD,MAAMC,aAAaD,QAAQE,OAAO,CAACC,GAAG,CAAC;IACvC,IAAIF,eAAe,WAAWA,eAAe,aAAaA,eAAe,UAAU;QACjF,OAAOA;IACT;IAEA,OAAO;AACT;AAEO,SAASG,iBAAiBJ,OAAoB;IACnD,OAAOA,QAAQE,OAAO,CAACC,GAAG,CAAC,gBAAgB;AAC7C;AAEO,SAASE,kBAAkBL,OAAoB,EAAEM,UAA0B;IAChF,MAAMC,OAAOR,eAAeC;IAC5B,IAAI,CAACL,UAAU,CAACY,KAAK,CAACC,QAAQ,CAACF,aAAa;QAC1C,MAAM,IAAI,kIAAQ,CAAC,aAAa,8CAA8C;IAChF;AACF"}},
    {"offset": {"line": 206, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/app/api/farms/%5BfarmId%5D/invites/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { z } from 'zod';\r\nimport { createErrorResponse, AppError } from '@/lib/errors';\r\nimport { prisma } from '@/lib/prisma';\r\nimport { getRequestRole } from '@/lib/permissions';\r\n\r\nconst createInviteSchema = z.object({\r\n  email: z.string().email(),\r\n  role: z.enum(['MANAGER', 'WORKER']),\r\n});\r\n\r\nexport async function GET(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ farmId: string }> }\r\n) {\r\n  try {\r\n    const { farmId } = await context.params;\r\n    const events = await prisma.event.findMany({\r\n      where: {\r\n        farmId,\r\n        type: 'USER_INVITE_CREATED',\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: 50,\r\n    });\r\n\r\n    const data = events.map((event) => {\r\n      const payload = event.payload as {\r\n        token: string;\r\n        email: string;\r\n        role: 'MANAGER' | 'WORKER';\r\n        status: 'PENDING' | 'ACCEPTED' | 'EXPIRED';\r\n        inviteUrl: string;\r\n        expiresAt: string;\r\n      };\r\n\r\n      return {\r\n        id: event.id,\r\n        email: payload.email,\r\n        role: payload.role,\r\n        status: payload.status,\r\n        inviteUrl: payload.inviteUrl,\r\n        expiresAt: payload.expiresAt,\r\n        createdAt: event.createdAt,\r\n      };\r\n    });\r\n\r\n    return Response.json({ success: true, data });\r\n  } catch (error) {\r\n    return createErrorResponse(error);\r\n  }\r\n}\r\n\r\nexport async function POST(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ farmId: string }> }\r\n) {\r\n  try {\r\n    const role = getRequestRole(request);\r\n    if (role !== 'OWNER') {\r\n      throw new AppError('FORBIDDEN', 'Only owners can invite users', 403);\r\n    }\r\n\r\n    const { farmId } = await context.params;\r\n    const farm = await prisma.farm.findUnique({ where: { id: farmId } });\r\n    if (!farm) {\r\n      throw new AppError('FARM_NOT_FOUND', 'Farm not found. Select a valid farm before sending invites.', 404);\r\n    }\r\n\r\n    const body = await request.json();\r\n    const input = createInviteSchema.parse(body);\r\n\r\n    const token = crypto.randomUUID();\r\n    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);\r\n    const origin = request.nextUrl.origin;\r\n    const inviteUrl = `${origin}/auth/invite/${token}`;\r\n\r\n    const requestUserId = request.headers.get('x-user-id') || undefined;\r\n\r\n    const created = await prisma.event.create({\r\n      data: {\r\n        farmId,\r\n        type: 'USER_INVITE_CREATED',\r\n        payload: {\r\n          token,\r\n          email: input.email.toLowerCase(),\r\n          role: input.role,\r\n          status: 'PENDING',\r\n          inviteUrl,\r\n          expiresAt: expiresAt.toISOString(),\r\n        },\r\n        userId: requestUserId,\r\n        idempotencyKey: `invite:${farmId}:${token}`,\r\n      },\r\n    });\r\n\r\n    return Response.json({\r\n      success: true,\r\n      data: {\r\n        id: created.id,\r\n        email: input.email.toLowerCase(),\r\n        role: input.role,\r\n        inviteUrl,\r\n        token,\r\n        expiresAt: expiresAt.toISOString(),\r\n      },\r\n    });\r\n  } catch (error) {\r\n    return createErrorResponse(error);\r\n  }\r\n}\r\n"],"names":["createInviteSchema","object","email","string","role","enum","GET","request","context","farmId","params","events","event","findMany","where","type","orderBy","createdAt","take","data","map","payload","id","status","inviteUrl","expiresAt","Response","json","success","error","POST","farm","findUnique","body","input","parse","token","crypto","randomUUID","Date","now","origin","nextUrl","requestUserId","headers","get","undefined","created","create","toLowerCase","toISOString","userId","idempotencyKey"],"mappings":"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"}}]
}