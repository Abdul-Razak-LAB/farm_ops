{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/lib/rate-limit.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\n\r\ntype RateLimitProfile = {\r\n  limit: number;\r\n  windowSeconds: number;\r\n};\r\n\r\nconst profiles: Record<'auth' | 'write', RateLimitProfile> = {\r\n  auth: { limit: 10, windowSeconds: 60 },\r\n  write: { limit: 120, windowSeconds: 60 },\r\n};\r\n\r\nconst memoryStore = new Map<string, { count: number; resetAt: number }>();\r\n\r\nfunction getClientIp(request: NextRequest) {\r\n  const forwarded = request.headers.get('x-forwarded-for');\r\n  if (forwarded) {\r\n    return forwarded.split(',')[0]?.trim() || 'unknown-ip';\r\n  }\r\n  return 'unknown-ip';\r\n}\r\n\r\nasync function incrementInRedis(key: string, windowSeconds: number) {\r\n  const redisUrl = process.env.UPSTASH_REDIS_URL;\r\n  const redisToken = process.env.UPSTASH_REDIS_TOKEN;\r\n\r\n  if (!redisUrl || !redisToken) {\r\n    return null;\r\n  }\r\n\r\n  const headers = { Authorization: `Bearer ${redisToken}` };\r\n  const encodedKey = encodeURIComponent(key);\r\n\r\n  const incrResponse = await fetch(`${redisUrl}/incr/${encodedKey}`, { headers, cache: 'no-store' });\r\n  if (!incrResponse.ok) {\r\n    return null;\r\n  }\r\n\r\n  const incrJson = (await incrResponse.json()) as { result?: number };\r\n  const count = Number(incrJson.result || 0);\r\n\r\n  if (count <= 1) {\r\n    await fetch(`${redisUrl}/expire/${encodedKey}/${windowSeconds}`, { headers, cache: 'no-store' });\r\n  }\r\n\r\n  return count;\r\n}\r\n\r\nfunction incrementInMemory(key: string, windowSeconds: number) {\r\n  const now = Date.now();\r\n  const current = memoryStore.get(key);\r\n  const nextResetAt = now + windowSeconds * 1000;\r\n\r\n  if (!current || current.resetAt <= now) {\r\n    memoryStore.set(key, { count: 1, resetAt: nextResetAt });\r\n    return 1;\r\n  }\r\n\r\n  const nextCount = current.count + 1;\r\n  memoryStore.set(key, { count: nextCount, resetAt: current.resetAt });\r\n  return nextCount;\r\n}\r\n\r\nexport async function checkRateLimit(input: {\r\n  request: NextRequest;\r\n  profile: 'auth' | 'write';\r\n  userId?: string;\r\n  farmId?: string;\r\n}) {\r\n  const config = profiles[input.profile];\r\n  const ip = getClientIp(input.request);\r\n  const route = input.request.nextUrl.pathname;\r\n  const identity = [ip, input.userId || 'anon-user', input.farmId || 'no-farm'].join(':');\r\n  const key = `rl:${input.profile}:${route}:${identity}`;\r\n\r\n  const redisCount = await incrementInRedis(key, config.windowSeconds);\r\n  const count = redisCount ?? incrementInMemory(key, config.windowSeconds);\r\n\r\n  const limited = count > config.limit;\r\n  return {\r\n    limited,\r\n    limit: config.limit,\r\n    remaining: Math.max(0, config.limit - count),\r\n    retryAfterSeconds: config.windowSeconds,\r\n  };\r\n}\r\n"],"names":["profiles","auth","limit","windowSeconds","write","memoryStore","Map","getClientIp","request","forwarded","headers","get","split","trim","incrementInRedis","key","redisUrl","process","env","UPSTASH_REDIS_URL","redisToken","UPSTASH_REDIS_TOKEN","Authorization","encodedKey","encodeURIComponent","incrResponse","fetch","cache","ok","incrJson","json","count","Number","result","incrementInMemory","now","Date","current","nextResetAt","resetAt","set","nextCount","checkRateLimit","input","config","profile","ip","route","nextUrl","pathname","identity","userId","farmId","join","redisCount","limited","remaining","Math","max","retryAfterSeconds"],"mappings":";;;;AAOA,MAAMA,WAAuD;IAC3DC,MAAM;QAAEC,OAAO;QAAIC,eAAe;IAAG;IACrCC,OAAO;QAAEF,OAAO;QAAKC,eAAe;IAAG;AACzC;AAEA,MAAME,cAAc,IAAIC;AAExB,SAASC,YAAYC,OAAoB;IACvC,MAAMC,YAAYD,QAAQE,OAAO,CAACC,GAAG,CAAC;IACtC,IAAIF,WAAW;QACb,OAAOA,UAAUG,KAAK,CAAC,IAAI,CAAC,EAAE,EAAEC,UAAU;IAC5C;IACA,OAAO;AACT;AAEA,eAAeC,iBAAiBC,GAAW,EAAEZ,aAAqB;IAChE,MAAMa,WAAWC,QAAQC,GAAG,CAACC,iBAAiB;IAC9C,MAAMC,aAAaH,QAAQC,GAAG,CAACG,mBAAmB;IAElD,IAAI,CAACL,YAAY,CAACI,YAAY;QAC5B,OAAO;IACT;IAEA,MAAMV,UAAU;QAAEY,eAAe,CAAC,OAAO,EAAEF,YAAY;IAAC;IACxD,MAAMG,aAAaC,mBAAmBT;IAEtC,MAAMU,eAAe,MAAMC,MAAM,GAAGV,SAAS,MAAM,EAAEO,YAAY,EAAE;QAAEb;QAASiB,OAAO;IAAW;IAChG,IAAI,CAACF,aAAaG,EAAE,EAAE;QACpB,OAAO;IACT;IAEA,MAAMC,WAAY,MAAMJ,aAAaK,IAAI;IACzC,MAAMC,QAAQC,OAAOH,SAASI,MAAM,IAAI;IAExC,IAAIF,SAAS,GAAG;QACd,MAAML,MAAM,GAAGV,SAAS,QAAQ,EAAEO,WAAW,CAAC,EAAEpB,eAAe,EAAE;YAAEO;YAASiB,OAAO;QAAW;IAChG;IAEA,OAAOI;AACT;AAEA,SAASG,kBAAkBnB,GAAW,EAAEZ,aAAqB;IAC3D,MAAMgC,MAAMC,KAAKD,GAAG;IACpB,MAAME,UAAUhC,YAAYM,GAAG,CAACI;IAChC,MAAMuB,cAAcH,MAAMhC,gBAAgB;IAE1C,IAAI,CAACkC,WAAWA,QAAQE,OAAO,IAAIJ,KAAK;QACtC9B,YAAYmC,GAAG,CAACzB,KAAK;YAAEgB,OAAO;YAAGQ,SAASD;QAAY;QACtD,OAAO;IACT;IAEA,MAAMG,YAAYJ,QAAQN,KAAK,GAAG;IAClC1B,YAAYmC,GAAG,CAACzB,KAAK;QAAEgB,OAAOU;QAAWF,SAASF,QAAQE,OAAO;IAAC;IAClE,OAAOE;AACT;AAEO,eAAeC,eAAeC,KAKpC;IACC,MAAMC,SAAS5C,QAAQ,CAAC2C,MAAME,OAAO,CAAC;IACtC,MAAMC,KAAKvC,YAAYoC,MAAMnC,OAAO;IACpC,MAAMuC,QAAQJ,MAAMnC,OAAO,CAACwC,OAAO,CAACC,QAAQ;IAC5C,MAAMC,WAAW;QAACJ;QAAIH,MAAMQ,MAAM,IAAI;QAAaR,MAAMS,MAAM,IAAI;KAAU,CAACC,IAAI,CAAC;IACnF,MAAMtC,MAAM,CAAC,GAAG,EAAE4B,MAAME,OAAO,CAAC,CAAC,EAAEE,MAAM,CAAC,EAAEG,UAAU;IAEtD,MAAMI,aAAa,MAAMxC,iBAAiBC,KAAK6B,OAAOzC,aAAa;IACnE,MAAM4B,QAAQuB,cAAcpB,kBAAkBnB,KAAK6B,OAAOzC,aAAa;IAEvE,MAAMoD,UAAUxB,QAAQa,OAAO1C,KAAK;IACpC,OAAO;QACLqD;QACArD,OAAO0C,OAAO1C,KAAK;QACnBsD,WAAWC,KAAKC,GAAG,CAAC,GAAGd,OAAO1C,KAAK,GAAG6B;QACtC4B,mBAAmBf,OAAOzC,aAAa;IACzC;AACF"}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/middleware.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { checkRateLimit } from '@/lib/rate-limit';\r\n\r\nexport async function middleware(request: NextRequest) {\r\n  const response = NextResponse.next();\r\n\r\n  // 1. Security Headers\r\n  response.headers.set('X-Content-Type-Options', 'nosniff');\r\n  response.headers.set('X-Frame-Options', 'DENY');\r\n  response.headers.set('X-XSS-Protection', '1; mode=block');\r\n  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');\r\n  response.headers.set(\r\n    'Content-Security-Policy',\r\n    \"default-src 'self'; script-src 'self'; object-src 'none';\"\r\n  );\r\n\r\n  // 2. Auth Check (Simplistic version for brevity)\r\n  // In production, use session token validation against DB/Redis\r\n  const sessionToken = request.cookies.get('session_token')?.value;\r\n  const isAuthRoute = request.nextUrl.pathname.startsWith('/api/auth');\r\n  const isAuthMutation = request.nextUrl.pathname === '/api/auth/login' || request.nextUrl.pathname === '/api/auth/signup';\r\n  const isPublicRoute = request.nextUrl.pathname === '/';\r\n  const isStateChanging = ['POST', 'PUT', 'PATCH', 'DELETE'].includes(request.method);\r\n  const farmMatch = request.nextUrl.pathname.match(/^\\/api\\/farms\\/([^/]+)/);\r\n  const farmId = farmMatch?.[1];\r\n  const userId = request.headers.get('x-user-id') || undefined;\r\n\r\n  if (isAuthMutation || (isStateChanging && request.nextUrl.pathname.startsWith('/api'))) {\r\n    const rate = await checkRateLimit({\r\n      request,\r\n      profile: isAuthMutation ? 'auth' : 'write',\r\n      userId,\r\n      farmId,\r\n    });\r\n\r\n    if (rate.limited) {\r\n      return Response.json(\r\n        {\r\n          success: false,\r\n          error: {\r\n            code: 'RATE_LIMITED',\r\n            message: 'Too many requests. Please retry later.',\r\n            details: { retryAfterSeconds: rate.retryAfterSeconds },\r\n          },\r\n        },\r\n        {\r\n          status: 429,\r\n          headers: {\r\n            'Retry-After': String(rate.retryAfterSeconds),\r\n          },\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  if (!sessionToken && !isAuthRoute && !isPublicRoute && request.nextUrl.pathname.startsWith('/api')) {\r\n    return Response.json(\r\n      { success: false, error: { code: 'UNAUTHORIZED', message: 'Auth required' } },\r\n      { status: 401 }\r\n    );\r\n  }\r\n\r\n  if (isStateChanging && request.nextUrl.pathname.startsWith('/api')) {\r\n    const origin = request.headers.get('origin');\r\n    const host = request.headers.get('host');\r\n    if (origin && host) {\r\n      const originHost = new URL(origin).host;\r\n      if (originHost !== host) {\r\n        return Response.json(\r\n          { success: false, error: { code: 'FORBIDDEN_ORIGIN', message: 'Invalid request origin' } },\r\n          { status: 403 }\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  return response;\r\n}\r\n\r\nexport const config = {\r\n  matcher: ['/api/:path*'],\r\n};\r\n"],"names":["middleware","request","response","next","headers","set","sessionToken","cookies","get","value","isAuthRoute","nextUrl","pathname","startsWith","isAuthMutation","isPublicRoute","isStateChanging","includes","method","farmMatch","match","farmId","userId","undefined","rate","profile","limited","Response","json","success","error","code","message","details","retryAfterSeconds","status","String","origin","host","originHost","URL","config","matcher"],"mappings":";;;;;;AAAA;AAAA;AACA;;;AAEO,eAAeA,WAAWC,OAAoB;IACnD,MAAMC,WAAW,gMAAY,CAACC,IAAI;IAElC,sBAAsB;IACtBD,SAASE,OAAO,CAACC,GAAG,CAAC,0BAA0B;IAC/CH,SAASE,OAAO,CAACC,GAAG,CAAC,mBAAmB;IACxCH,SAASE,OAAO,CAACC,GAAG,CAAC,oBAAoB;IACzCH,SAASE,OAAO,CAACC,GAAG,CAAC,mBAAmB;IACxCH,SAASE,OAAO,CAACC,GAAG,CAClB,2BACA;IAGF,iDAAiD;IACjD,+DAA+D;IAC/D,MAAMC,eAAeL,QAAQM,OAAO,CAACC,GAAG,CAAC,kBAAkBC;IAC3D,MAAMC,cAAcT,QAAQU,OAAO,CAACC,QAAQ,CAACC,UAAU,CAAC;IACxD,MAAMC,iBAAiBb,QAAQU,OAAO,CAACC,QAAQ,KAAK,qBAAqBX,QAAQU,OAAO,CAACC,QAAQ,KAAK;IACtG,MAAMG,gBAAgBd,QAAQU,OAAO,CAACC,QAAQ,KAAK;IACnD,MAAMI,kBAAkB;QAAC;QAAQ;QAAO;QAAS;KAAS,CAACC,QAAQ,CAAChB,QAAQiB,MAAM;IAClF,MAAMC,YAAYlB,QAAQU,OAAO,CAACC,QAAQ,CAACQ,KAAK,CAAC;IACjD,MAAMC,SAASF,WAAW,CAAC,EAAE;IAC7B,MAAMG,SAASrB,QAAQG,OAAO,CAACI,GAAG,CAAC,gBAAgBe;IAEnD,IAAIT,kBAAmBE,mBAAmBf,QAAQU,OAAO,CAACC,QAAQ,CAACC,UAAU,CAAC,SAAU;QACtF,MAAMW,OAAO,MAAM,IAAA,qJAAc,EAAC;YAChCvB;YACAwB,SAASX,iBAAiB,SAAS;YACnCQ;YACAD;QACF;QAEA,IAAIG,KAAKE,OAAO,EAAE;YAChB,OAAOC,SAASC,IAAI,CAClB;gBACEC,SAAS;gBACTC,OAAO;oBACLC,MAAM;oBACNC,SAAS;oBACTC,SAAS;wBAAEC,mBAAmBV,KAAKU,iBAAiB;oBAAC;gBACvD;YACF,GACA;gBACEC,QAAQ;gBACR/B,SAAS;oBACP,eAAegC,OAAOZ,KAAKU,iBAAiB;gBAC9C;YACF;QAEJ;IACF;IAEA,IAAI,CAAC5B,gBAAgB,CAACI,eAAe,CAACK,iBAAiBd,QAAQU,OAAO,CAACC,QAAQ,CAACC,UAAU,CAAC,SAAS;QAClG,OAAOc,SAASC,IAAI,CAClB;YAAEC,SAAS;YAAOC,OAAO;gBAAEC,MAAM;gBAAgBC,SAAS;YAAgB;QAAE,GAC5E;YAAEG,QAAQ;QAAI;IAElB;IAEA,IAAInB,mBAAmBf,QAAQU,OAAO,CAACC,QAAQ,CAACC,UAAU,CAAC,SAAS;QAClE,MAAMwB,SAASpC,QAAQG,OAAO,CAACI,GAAG,CAAC;QACnC,MAAM8B,OAAOrC,QAAQG,OAAO,CAACI,GAAG,CAAC;QACjC,IAAI6B,UAAUC,MAAM;YAClB,MAAMC,aAAa,IAAIC,IAAIH,QAAQC,IAAI;YACvC,IAAIC,eAAeD,MAAM;gBACvB,OAAOX,SAASC,IAAI,CAClB;oBAAEC,SAAS;oBAAOC,OAAO;wBAAEC,MAAM;wBAAoBC,SAAS;oBAAyB;gBAAE,GACzF;oBAAEG,QAAQ;gBAAI;YAElB;QACF;IACF;IAEA,OAAOjC;AACT;AAEO,MAAMuC,SAAS;IACpBC,SAAS;QAAC;KAAc;AAC1B"}}]
}