{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/errors.ts"],"sourcesContent":["export class AppError extends Error {\r\n  public code: string;\r\n  public status: number;\r\n  public details?: any;\r\n\r\n  constructor(code: string, message: string, status: number = 400, details?: any) {\r\n    super(message);\r\n    this.name = 'AppError';\r\n    this.code = code;\r\n    this.status = status;\r\n    this.details = details;\r\n  }\r\n}\r\n\r\nexport function createErrorResponse(error: any) {\r\n  if (error instanceof AppError || (error?.name === 'AppError' && error?.code && error?.message)) {\r\n    return Response.json(\r\n      { success: false, error: { code: error.code, message: error.message, details: error.details } },\r\n      { status: error.status || 400 }\r\n    );\r\n  }\r\n\r\n  if (error?.name === 'ZodError') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: 'VALIDATION_ERROR',\r\n          message: 'Invalid request payload',\r\n          details: error.issues ?? error.errors,\r\n        },\r\n      },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  if (error?.code === 'P2002') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: 'CONFLICT',\r\n          message: 'A record with the same unique value already exists',\r\n          details: error.meta,\r\n        },\r\n      },\r\n      { status: 409 }\r\n    );\r\n  }\r\n\r\n  if (error?.code === 'P2003') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: 'RELATION_ERROR',\r\n          message: 'Related record is missing or invalid',\r\n          details: error.meta,\r\n        },\r\n      },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  console.error('[Unhandled Error]:', error);\r\n\r\n  if (process.env.NODE_ENV !== 'production') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: error?.code || 'INTERNAL_ERROR',\r\n          message: error?.message || 'Unknown server error',\r\n          details: error?.stack || error,\r\n        },\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n\r\n  return Response.json(\r\n    { success: false, error: { code: 'INTERNAL_ERROR', message: 'An unexpected error occurred' } },\r\n    { status: 500 }\r\n  );\r\n}\r\n"],"names":["AppError","Error","code","status","details","message","name","createErrorResponse","error","Response","json","success","issues","errors","meta","console","stack"],"mappings":";;;;;;AAAO,MAAMA,iBAAiBC;IACrBC,KAAa;IACbC,OAAe;IACfC,QAAc;IAErBJ,YAAYE,IAAY,EAAEG,OAAe,EAAEF,SAAiB,GAAG,EAAEC,OAAa,CAAE;QAC9E,KAAK,CAACC;QACN,IAAI,CAACC,IAAI,GAAG;QACZ,IAAI,CAACJ,IAAI,GAAGA;QACZ,IAAI,CAACC,MAAM,GAAGA;QACd,IAAI,CAACC,OAAO,GAAGA;IACjB;AACF;AAEO,SAASG,oBAAoBC,KAAU;IAC5C,IAAIA,iBAAiBR,YAAaQ,OAAOF,SAAS,cAAcE,OAAON,QAAQM,OAAOH,SAAU;QAC9F,OAAOI,SAASC,IAAI,CAClB;YAAEC,SAAS;YAAOH,OAAO;gBAAEN,MAAMM,MAAMN,IAAI;gBAAEG,SAASG,MAAMH,OAAO;gBAAED,SAASI,MAAMJ,OAAO;YAAC;QAAE,GAC9F;YAAED,QAAQK,MAAML,MAAM,IAAI;QAAI;IAElC;IAEA,IAAIK,OAAOF,SAAS,YAAY;QAC9B,OAAOG,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAM;gBACNG,SAAS;gBACTD,SAASI,MAAMI,MAAM,IAAIJ,MAAMK,MAAM;YACvC;QACF,GACA;YAAEV,QAAQ;QAAI;IAElB;IAEA,IAAIK,OAAON,SAAS,SAAS;QAC3B,OAAOO,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAM;gBACNG,SAAS;gBACTD,SAASI,MAAMM,IAAI;YACrB;QACF,GACA;YAAEX,QAAQ;QAAI;IAElB;IAEA,IAAIK,OAAON,SAAS,SAAS;QAC3B,OAAOO,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAM;gBACNG,SAAS;gBACTD,SAASI,MAAMM,IAAI;YACrB;QACF,GACA;YAAEX,QAAQ;QAAI;IAElB;IAEAY,QAAQP,KAAK,CAAC,sBAAsBA;IAEpC,wCAA2C;QACzC,OAAOC,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAMM,OAAON,QAAQ;gBACrBG,SAASG,OAAOH,WAAW;gBAC3BD,SAASI,OAAOQ,SAASR;YAC3B;QACF,GACA;YAAEL,QAAQ;QAAI;IAElB;;;AAMF"}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/permissions.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { AppError } from './errors';\r\n\r\nexport type FarmPermission =\r\n  | 'finance:read'\r\n  | 'finance:write'\r\n  | 'finance:approve'\r\n  | 'updates:read'\r\n  | 'updates:write'\r\n  | 'digest:read'\r\n  | 'monitoring:read'\r\n  | 'monitoring:write'\r\n  | 'incident:read'\r\n  | 'incident:write'\r\n  | 'vendor:read'\r\n  | 'vendor:write'\r\n  | 'procurement:read'\r\n  | 'procurement:write'\r\n  | 'payroll:read'\r\n  | 'payroll:write'\r\n  | 'payroll:approve'\r\n  | 'payroll:pay';\r\n\r\ntype FarmRole = 'OWNER' | 'MANAGER' | 'WORKER';\r\n\r\nconst roleMatrix: Record<FarmRole, FarmPermission[]> = {\r\n  OWNER: [\r\n    'finance:read',\r\n    'finance:write',\r\n    'finance:approve',\r\n    'updates:read',\r\n    'updates:write',\r\n    'digest:read',\r\n    'monitoring:read',\r\n    'monitoring:write',\r\n    'incident:read',\r\n    'incident:write',\r\n    'vendor:read',\r\n    'vendor:write',\r\n    'procurement:read',\r\n    'procurement:write',\r\n    'payroll:read',\r\n    'payroll:write',\r\n    'payroll:approve',\r\n    'payroll:pay',\r\n  ],\r\n  MANAGER: [\r\n    'finance:read',\r\n    'finance:write',\r\n    'updates:read',\r\n    'updates:write',\r\n    'digest:read',\r\n    'monitoring:read',\r\n    'monitoring:write',\r\n    'incident:read',\r\n    'incident:write',\r\n    'vendor:read',\r\n    'vendor:write',\r\n    'procurement:read',\r\n    'procurement:write',\r\n    'payroll:read',\r\n    'payroll:write',\r\n  ],\r\n  WORKER: ['updates:read', 'updates:write', 'incident:read', 'incident:write', 'procurement:read'],\r\n};\r\n\r\nexport function getRequestRole(request: NextRequest): FarmRole {\r\n  const headerRole = request.headers.get('x-farm-role');\r\n  if (headerRole === 'OWNER' || headerRole === 'MANAGER' || headerRole === 'WORKER') {\r\n    return headerRole;\r\n  }\r\n\r\n  return 'MANAGER';\r\n}\r\n\r\nexport function getRequestUserId(request: NextRequest): string {\r\n  return request.headers.get('x-user-id') || 'user_id_from_session';\r\n}\r\n\r\nexport function requirePermission(request: NextRequest, permission: FarmPermission) {\r\n  const role = getRequestRole(request);\r\n  if (!roleMatrix[role].includes(permission)) {\r\n    throw new AppError('FORBIDDEN', 'You do not have permission for this action', 403);\r\n  }\r\n}\r\n"],"names":["roleMatrix","OWNER","MANAGER","WORKER","getRequestRole","request","headerRole","headers","get","getRequestUserId","requirePermission","permission","role","includes"],"mappings":";;;;;;;;AACA;;AAwBA,MAAMA,aAAiD;IACrDC,OAAO;QACL;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACDC,SAAS;QACP;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACDC,QAAQ;QAAC;QAAgB;QAAiB;QAAiB;QAAkB;KAAmB;AAClG;AAEO,SAASC,eAAeC,OAAoB;IACjD,MAAMC,aAAaD,QAAQE,OAAO,CAACC,GAAG,CAAC;IACvC,IAAIF,eAAe,WAAWA,eAAe,aAAaA,eAAe,UAAU;QACjF,OAAOA;IACT;IAEA,OAAO;AACT;AAEO,SAASG,iBAAiBJ,OAAoB;IACnD,OAAOA,QAAQE,OAAO,CAACC,GAAG,CAAC,gBAAgB;AAC7C;AAEO,SAASE,kBAAkBL,OAAoB,EAAEM,UAA0B;IAChF,MAAMC,OAAOR,eAAeC;IAC5B,IAAI,CAACL,UAAU,CAACY,KAAK,CAACC,QAAQ,CAACF,aAAa;QAC1C,MAAM,IAAI,kIAAQ,CAAC,aAAa,8CAA8C;IAChF;AACF"}},
    {"offset": {"line": 203, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\n\r\nconst globalForPrisma = globalThis as unknown as { prisma: PrismaClient };\r\n\r\nexport const prisma = globalForPrisma.prisma || new PrismaClient();\r\n\r\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\r\n"],"names":["globalForPrisma","globalThis","prisma"],"mappings":";;;;AAAA;;AAEA,MAAMA,kBAAkBC;AAEjB,MAAMC,SAASF,gBAAgBE,MAAM,IAAI,IAAI,sMAAY;AAEhE,wCAA2CF,gBAAgBE,MAAM,GAAGA"}},
    {"offset": {"line": 216, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/services/monitoring/monitoring-service.ts"],"sourcesContent":["import { prisma } from '@/lib/prisma';\r\nimport { AppError } from '@/lib/errors';\r\n\r\ntype VraZoneInput = {\r\n  zoneId: string;\r\n  name: string;\r\n  hectares: number;\r\n  productivityIndex: number;\r\n};\r\n\r\ntype VraPlanInput = {\r\n  farmId: string;\r\n  userId: string;\r\n  idempotencyKey: string;\r\n  zones: VraZoneInput[];\r\n  market: {\r\n    commodityPricePerTon: number;\r\n    seedCostPerKg: number;\r\n    fertilizerCostPerKg: number;\r\n    targetMarginPerHa: number;\r\n  };\r\n  intelligence: {\r\n    weatherRisk: 'LOW' | 'MEDIUM' | 'HIGH';\r\n    pestPressure: 'LOW' | 'MEDIUM' | 'HIGH';\r\n    maxYieldPotentialTonsPerHa: number;\r\n  };\r\n};\r\n\r\ntype VraFeedbackInput = {\r\n  farmId: string;\r\n  userId: string;\r\n  idempotencyKey: string;\r\n  outcomes: Array<{\r\n    zoneId: string;\r\n    recommendedYieldPerHa: number;\r\n    actualYieldPerHa: number;\r\n  }>;\r\n};\r\n\r\nexport class MonitoringService {\r\n  async getDashboard(farmId: string) {\r\n    const [devices, unresolvedAlerts, latestReadings] = await Promise.all([\r\n      prisma.sensorDevice.findMany({\r\n        where: { farmId },\r\n        include: {\r\n          readings: {\r\n            orderBy: { createdAt: 'desc' },\r\n            take: 1,\r\n          },\r\n        },\r\n      }),\r\n      prisma.alert.findMany({\r\n        where: { farmId, resolved: false },\r\n        orderBy: { createdAt: 'desc' },\r\n        take: 20,\r\n      }),\r\n      prisma.sensorReading.findMany({\r\n        where: {\r\n          device: { farmId },\r\n        },\r\n        include: { device: true },\r\n        orderBy: { createdAt: 'desc' },\r\n        take: 30,\r\n      }),\r\n    ]);\r\n\r\n    return {\r\n      devices,\r\n      unresolvedAlerts,\r\n      latestReadings,\r\n      summary: {\r\n        totalDevices: devices.length,\r\n        unresolvedAlerts: unresolvedAlerts.length,\r\n      },\r\n    };\r\n  }\r\n\r\n  async triggerAlert(input: {\r\n    farmId: string;\r\n    userId: string;\r\n    level: 'INFO' | 'WARNING' | 'CRITICAL';\r\n    message: string;\r\n    idempotencyKey: string;\r\n  }) {\r\n    const existing = await prisma.event.findUnique({\r\n      where: {\r\n        farmId_idempotencyKey: {\r\n          farmId: input.farmId,\r\n          idempotencyKey: input.idempotencyKey,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (existing) {\r\n      return { reused: true };\r\n    }\r\n\r\n    const alert = await prisma.$transaction(async (tx: any) => {\r\n      const createdAlert = await tx.alert.create({\r\n        data: {\r\n          farmId: input.farmId,\r\n          level: input.level,\r\n          message: input.message,\r\n          resolved: false,\r\n        },\r\n      });\r\n\r\n      await tx.event.create({\r\n        data: {\r\n          farmId: input.farmId,\r\n          type: 'SENSOR_ALERT_TRIGGERED',\r\n          payload: {\r\n            alertId: createdAlert.id,\r\n            level: input.level,\r\n            message: input.message,\r\n          },\r\n          userId: input.userId,\r\n          idempotencyKey: input.idempotencyKey,\r\n        },\r\n      });\r\n\r\n      return createdAlert;\r\n    }, { isolationLevel: 'Serializable' });\r\n\r\n    return alert;\r\n  }\r\n\r\n  async resolveAlert(input: { farmId: string; alertId: string; userId: string; idempotencyKey: string }) {\r\n    const alert = await prisma.alert.findFirst({ where: { id: input.alertId, farmId: input.farmId } });\r\n    if (!alert) {\r\n      throw new AppError('ALERT_NOT_FOUND', 'Alert not found', 404);\r\n    }\r\n\r\n    const existing = await prisma.event.findUnique({\r\n      where: {\r\n        farmId_idempotencyKey: {\r\n          farmId: input.farmId,\r\n          idempotencyKey: input.idempotencyKey,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (existing) {\r\n      return { reused: true };\r\n    }\r\n\r\n    await prisma.$transaction(async (tx: any) => {\r\n      await tx.alert.update({\r\n        where: { id: input.alertId },\r\n        data: { resolved: true },\r\n      });\r\n\r\n      await tx.event.create({\r\n        data: {\r\n          farmId: input.farmId,\r\n          type: 'ALERT_RESOLVED',\r\n          payload: { alertId: input.alertId },\r\n          userId: input.userId,\r\n          idempotencyKey: input.idempotencyKey,\r\n        },\r\n      });\r\n    }, { isolationLevel: 'Serializable' });\r\n\r\n    return { alertId: input.alertId, status: 'RESOLVED' };\r\n  }\r\n\r\n  private async getLearningAdjustment(farmId: string) {\r\n    const feedbackEvents = await prisma.event.findMany({\r\n      where: { farmId, type: 'VRA_FEEDBACK_RECORDED' },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: 30,\r\n    });\r\n\r\n    const errors: number[] = [];\r\n\r\n    for (const event of feedbackEvents) {\r\n      const payload = event.payload as any;\r\n      const outcomes = Array.isArray(payload?.outcomes) ? payload.outcomes : [];\r\n      for (const outcome of outcomes) {\r\n        const recommended = Number(outcome?.recommendedYieldPerHa || 0);\r\n        const actual = Number(outcome?.actualYieldPerHa || 0);\r\n        if (recommended > 0) {\r\n          errors.push((actual - recommended) / recommended);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (errors.length === 0) {\r\n      return {\r\n        adjustmentFactor: 1,\r\n        confidence: 0,\r\n        averageYieldError: 0,\r\n      };\r\n    }\r\n\r\n    const averageYieldError = errors.reduce((sum, value) => sum + value, 0) / errors.length;\r\n    const adjustmentFactor = Math.max(0.85, Math.min(1.15, 1 + averageYieldError * 0.35));\r\n    const confidence = Math.min(1, errors.length / 20);\r\n\r\n    return {\r\n      adjustmentFactor,\r\n      confidence,\r\n      averageYieldError,\r\n    };\r\n  }\r\n\r\n  async generateVraPlan(input: VraPlanInput) {\r\n    if (!input.zones.length) {\r\n      throw new AppError('INVALID_ZONES', 'At least one productivity zone is required', 400);\r\n    }\r\n\r\n    const existing = await prisma.event.findUnique({\r\n      where: {\r\n        farmId_idempotencyKey: {\r\n          farmId: input.farmId,\r\n          idempotencyKey: input.idempotencyKey,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (existing) {\r\n      return existing.payload as any;\r\n    }\r\n\r\n    const learning = await this.getLearningAdjustment(input.farmId);\r\n\r\n    const phase1 = input.zones.map((zone) => {\r\n      const band = zone.productivityIndex < 0.4\r\n        ? 'LOW'\r\n        : zone.productivityIndex < 0.7\r\n          ? 'MEDIUM'\r\n          : 'HIGH';\r\n\r\n      return {\r\n        zoneId: zone.zoneId,\r\n        zoneName: zone.name,\r\n        hectares: zone.hectares,\r\n        productivityIndex: zone.productivityIndex,\r\n        applicationBand: band,\r\n      };\r\n    });\r\n\r\n    const weatherModifier = input.intelligence.weatherRisk === 'HIGH' ? 0.92 : input.intelligence.weatherRisk === 'MEDIUM' ? 0.97 : 1.02;\r\n    const pestModifier = input.intelligence.pestPressure === 'HIGH' ? 0.94 : input.intelligence.pestPressure === 'MEDIUM' ? 0.98 : 1.03;\r\n\r\n    const phase2 = phase1.map((zone) => {\r\n      const seedBandFactor = zone.applicationBand === 'LOW' ? 0.9 : zone.applicationBand === 'HIGH' ? 1.12 : 1;\r\n      const fertilizerBandFactor = zone.applicationBand === 'LOW' ? 0.88 : zone.applicationBand === 'HIGH' ? 1.15 : 1;\r\n\r\n      const seedRateKgPerHa = Number((22 * seedBandFactor * learning.adjustmentFactor).toFixed(2));\r\n      const fertilizerRateKgPerHa = Number((180 * fertilizerBandFactor * learning.adjustmentFactor).toFixed(2));\r\n\r\n      return {\r\n        zoneId: zone.zoneId,\r\n        zoneName: zone.zoneName,\r\n        hectares: zone.hectares,\r\n        seedRateKgPerHa,\r\n        fertilizerRateKgPerHa,\r\n      };\r\n    });\r\n\r\n    const optimizedZones = phase2.map((zone) => {\r\n      const productivity = phase1.find((item) => item.zoneId === zone.zoneId)?.productivityIndex || 0.5;\r\n      const estimatedYieldPerHa = Number((\r\n        input.intelligence.maxYieldPotentialTonsPerHa * productivity * weatherModifier * pestModifier\r\n      ).toFixed(2));\r\n\r\n      const grossRevenue = estimatedYieldPerHa * input.market.commodityPricePerTon * zone.hectares;\r\n      const inputCost = (\r\n        zone.seedRateKgPerHa * input.market.seedCostPerKg +\r\n        zone.fertilizerRateKgPerHa * input.market.fertilizerCostPerKg\r\n      ) * zone.hectares;\r\n\r\n      let adjustedSeedRateKgPerHa = zone.seedRateKgPerHa;\r\n      let adjustedFertilizerRateKgPerHa = zone.fertilizerRateKgPerHa;\r\n\r\n      const marginPerHa = (grossRevenue - inputCost) / zone.hectares;\r\n      if (marginPerHa < input.market.targetMarginPerHa) {\r\n        adjustedSeedRateKgPerHa = Number((zone.seedRateKgPerHa * 0.96).toFixed(2));\r\n        adjustedFertilizerRateKgPerHa = Number((zone.fertilizerRateKgPerHa * 0.9).toFixed(2));\r\n      }\r\n\r\n      const adjustedInputCost = (\r\n        adjustedSeedRateKgPerHa * input.market.seedCostPerKg +\r\n        adjustedFertilizerRateKgPerHa * input.market.fertilizerCostPerKg\r\n      ) * zone.hectares;\r\n\r\n      const expectedMargin = grossRevenue - adjustedInputCost;\r\n\r\n      return {\r\n        zoneId: zone.zoneId,\r\n        zoneName: zone.zoneName,\r\n        hectares: zone.hectares,\r\n        estimatedYieldPerHa,\r\n        optimizedSeedRateKgPerHa: adjustedSeedRateKgPerHa,\r\n        optimizedFertilizerRateKgPerHa: adjustedFertilizerRateKgPerHa,\r\n        expectedRevenue: Number(grossRevenue.toFixed(2)),\r\n        expectedInputCost: Number(adjustedInputCost.toFixed(2)),\r\n        expectedMargin: Number(expectedMargin.toFixed(2)),\r\n      };\r\n    });\r\n\r\n    const totalExpectedMargin = optimizedZones.reduce((sum, zone) => sum + zone.expectedMargin, 0);\r\n    const averageYieldPerHa = optimizedZones.reduce((sum, zone) => sum + zone.estimatedYieldPerHa, 0) / optimizedZones.length;\r\n\r\n    const plan = {\r\n      phase1,\r\n      phase2,\r\n      phase3: {\r\n        zones: optimizedZones,\r\n        totals: {\r\n          expectedMargin: Number(totalExpectedMargin.toFixed(2)),\r\n          averageYieldPerHa: Number(averageYieldPerHa.toFixed(2)),\r\n        },\r\n      },\r\n      phase4: {\r\n        learningAdjustmentFactor: Number(learning.adjustmentFactor.toFixed(4)),\r\n        learningConfidence: Number(learning.confidence.toFixed(2)),\r\n        averageYieldError: Number(learning.averageYieldError.toFixed(4)),\r\n        recommendation: learning.confidence < 0.3\r\n          ? 'Collect more yield feedback to strengthen zone intelligence.'\r\n          : learning.averageYieldError < 0\r\n            ? 'Yields are below recommendations; reduce aggressive rates in low-productivity zones.'\r\n            : 'Yields are meeting/exceeding recommendations; keep optimized strategy and monitor risk shifts.',\r\n      },\r\n      generatedAt: new Date().toISOString(),\r\n    };\r\n\r\n    await prisma.event.create({\r\n      data: {\r\n        farmId: input.farmId,\r\n        type: 'VRA_PLAN_GENERATED',\r\n        payload: plan,\r\n        userId: input.userId,\r\n        idempotencyKey: input.idempotencyKey,\r\n      },\r\n    });\r\n\r\n    return plan;\r\n  }\r\n\r\n  async recordVraFeedback(input: VraFeedbackInput) {\r\n    if (!input.outcomes.length) {\r\n      throw new AppError('INVALID_FEEDBACK', 'At least one zone outcome is required', 400);\r\n    }\r\n\r\n    const existing = await prisma.event.findUnique({\r\n      where: {\r\n        farmId_idempotencyKey: {\r\n          farmId: input.farmId,\r\n          idempotencyKey: input.idempotencyKey,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (existing) {\r\n      return { reused: true };\r\n    }\r\n\r\n    await prisma.event.create({\r\n      data: {\r\n        farmId: input.farmId,\r\n        type: 'VRA_FEEDBACK_RECORDED',\r\n        payload: { outcomes: input.outcomes, recordedAt: new Date().toISOString() },\r\n        userId: input.userId,\r\n        idempotencyKey: input.idempotencyKey,\r\n      },\r\n    });\r\n\r\n    return { status: 'RECORDED' };\r\n  }\r\n}\r\n\r\nexport const monitoringService = new MonitoringService();\r\n"],"names":["MonitoringService","getDashboard","farmId","devices","unresolvedAlerts","latestReadings","Promise","all","sensorDevice","findMany","where","include","readings","orderBy","createdAt","take","alert","resolved","sensorReading","device","summary","totalDevices","length","triggerAlert","input","existing","event","findUnique","farmId_idempotencyKey","idempotencyKey","reused","$transaction","tx","createdAlert","create","data","level","message","type","payload","alertId","id","userId","isolationLevel","resolveAlert","findFirst","update","status","getLearningAdjustment","feedbackEvents","errors","outcomes","Array","isArray","outcome","recommended","Number","recommendedYieldPerHa","actual","actualYieldPerHa","push","adjustmentFactor","confidence","averageYieldError","reduce","sum","value","Math","max","min","generateVraPlan","zones","learning","phase1","map","zone","band","productivityIndex","zoneId","zoneName","name","hectares","applicationBand","weatherModifier","intelligence","weatherRisk","pestModifier","pestPressure","phase2","seedBandFactor","fertilizerBandFactor","seedRateKgPerHa","toFixed","fertilizerRateKgPerHa","optimizedZones","productivity","find","item","estimatedYieldPerHa","maxYieldPotentialTonsPerHa","grossRevenue","market","commodityPricePerTon","inputCost","seedCostPerKg","fertilizerCostPerKg","adjustedSeedRateKgPerHa","adjustedFertilizerRateKgPerHa","marginPerHa","targetMarginPerHa","adjustedInputCost","expectedMargin","optimizedSeedRateKgPerHa","optimizedFertilizerRateKgPerHa","expectedRevenue","expectedInputCost","totalExpectedMargin","averageYieldPerHa","plan","phase3","totals","phase4","learningAdjustmentFactor","learningConfidence","recommendation","generatedAt","Date","toISOString","recordVraFeedback","recordedAt","monitoringService"],"mappings":"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"}},
    {"offset": {"line": 546, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/app/api/farms/%5BfarmId%5D/monitoring/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { z } from 'zod';\r\nimport { createErrorResponse } from '@/lib/errors';\r\nimport { getRequestUserId, requirePermission } from '@/lib/permissions';\r\nimport { monitoringService } from '@/services/monitoring/monitoring-service';\r\n\r\nconst triggerSchema = z.object({\r\n  level: z.enum(['INFO', 'WARNING', 'CRITICAL']),\r\n  message: z.string().min(3),\r\n  idempotencyKey: z.string().min(8),\r\n});\r\n\r\nexport async function GET(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ farmId: string }> }\r\n) {\r\n  try {\r\n    requirePermission(request, 'monitoring:read');\r\n    const { farmId } = await context.params;\r\n    const data = await monitoringService.getDashboard(farmId);\r\n    return Response.json({ success: true, data });\r\n  } catch (error) {\r\n    return createErrorResponse(error);\r\n  }\r\n}\r\n\r\nexport async function POST(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ farmId: string }> }\r\n) {\r\n  try {\r\n    requirePermission(request, 'monitoring:write');\r\n    const { farmId } = await context.params;\r\n    const input = triggerSchema.parse(await request.json());\r\n    const userId = getRequestUserId(request);\r\n    const data = await monitoringService.triggerAlert({ farmId, userId, ...input });\r\n    return Response.json({ success: true, data });\r\n  } catch (error) {\r\n    return createErrorResponse(error);\r\n  }\r\n}\r\n"],"names":["triggerSchema","object","level","enum","message","string","min","idempotencyKey","GET","request","context","farmId","params","data","getDashboard","Response","json","success","error","POST","input","parse","userId","triggerAlert"],"mappings":";;;;;;AACA;AACA;AACA;AACA;;;;;AAEA,MAAMA,gBAAgB,yKAAC,CAACC,MAAM,CAAC;IAC7BC,OAAO,yKAAC,CAACC,IAAI,CAAC;QAAC;QAAQ;QAAW;KAAW;IAC7CC,SAAS,yKAAC,CAACC,MAAM,GAAGC,GAAG,CAAC;IACxBC,gBAAgB,yKAAC,CAACF,MAAM,GAAGC,GAAG,CAAC;AACjC;AAEO,eAAeE,IACpBC,OAAoB,EACpBC,OAAgD;IAEhD,IAAI;QACF,IAAA,gJAAiB,EAACD,SAAS;QAC3B,MAAM,EAAEE,MAAM,EAAE,GAAG,MAAMD,QAAQE,MAAM;QACvC,MAAMC,OAAO,MAAM,6KAAiB,CAACC,YAAY,CAACH;QAClD,OAAOI,SAASC,IAAI,CAAC;YAAEC,SAAS;YAAMJ;QAAK;IAC7C,EAAE,OAAOK,OAAO;QACd,OAAO,IAAA,6IAAmB,EAACA;IAC7B;AACF;AAEO,eAAeC,KACpBV,OAAoB,EACpBC,OAAgD;IAEhD,IAAI;QACF,IAAA,gJAAiB,EAACD,SAAS;QAC3B,MAAM,EAAEE,MAAM,EAAE,GAAG,MAAMD,QAAQE,MAAM;QACvC,MAAMQ,QAAQpB,cAAcqB,KAAK,CAAC,MAAMZ,QAAQO,IAAI;QACpD,MAAMM,SAAS,IAAA,+IAAgB,EAACb;QAChC,MAAMI,OAAO,MAAM,6KAAiB,CAACU,YAAY,CAAC;YAAEZ;YAAQW;YAAQ,GAAGF,KAAK;QAAC;QAC7E,OAAOL,SAASC,IAAI,CAAC;YAAEC,SAAS;YAAMJ;QAAK;IAC7C,EAAE,OAAOK,OAAO;QACd,OAAO,IAAA,6IAAmB,EAACA;IAC7B;AACF"}}]
}