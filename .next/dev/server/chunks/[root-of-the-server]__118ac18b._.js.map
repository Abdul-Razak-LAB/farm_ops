{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/logger.ts"],"sourcesContent":["type LogLevel = 'debug' | 'info' | 'warn' | 'error';\r\n\r\ntype LogContext = Record<string, unknown>;\r\n\r\nconst REDACT_KEYS = ['password', 'token', 'authorization', 'cookie', 'email', 'phone', 'secret'];\r\n\r\nfunction redactValue(value: unknown): unknown {\r\n  if (Array.isArray(value)) {\r\n    return value.map(redactValue);\r\n  }\r\n\r\n  if (value && typeof value === 'object') {\r\n    const entries = Object.entries(value as Record<string, unknown>).map(([key, val]) => {\r\n      const shouldRedact = REDACT_KEYS.some((redactKey) => key.toLowerCase().includes(redactKey));\r\n      return [key, shouldRedact ? '[REDACTED]' : redactValue(val)];\r\n    });\r\n    return Object.fromEntries(entries);\r\n  }\r\n\r\n  return value;\r\n}\r\n\r\nfunction emit(level: LogLevel, message: string, context?: LogContext) {\r\n  const payload = {\r\n    level,\r\n    message,\r\n    timestamp: new Date().toISOString(),\r\n    context: redactValue(context || {}),\r\n  };\r\n\r\n  const line = JSON.stringify(payload);\r\n  if (level === 'error') {\r\n    console.error(line);\r\n    return;\r\n  }\r\n\r\n  if (level === 'warn') {\r\n    console.warn(line);\r\n    return;\r\n  }\r\n\r\n  console.log(line);\r\n}\r\n\r\nexport const logger = {\r\n  debug: (message: string, context?: LogContext) => emit('debug', message, context),\r\n  info: (message: string, context?: LogContext) => emit('info', message, context),\r\n  warn: (message: string, context?: LogContext) => emit('warn', message, context),\r\n  error: (message: string, context?: LogContext) => emit('error', message, context),\r\n};\r\n"],"names":["REDACT_KEYS","redactValue","value","Array","isArray","map","entries","Object","key","val","shouldRedact","some","redactKey","toLowerCase","includes","fromEntries","emit","level","message","context","payload","timestamp","Date","toISOString","line","JSON","stringify","console","error","warn","log","logger","debug","info"],"mappings":";;;;AAIA,MAAMA,cAAc;IAAC;IAAY;IAAS;IAAiB;IAAU;IAAS;IAAS;CAAS;AAEhG,SAASC,YAAYC,KAAc;IACjC,IAAIC,MAAMC,OAAO,CAACF,QAAQ;QACxB,OAAOA,MAAMG,GAAG,CAACJ;IACnB;IAEA,IAAIC,SAAS,OAAOA,UAAU,UAAU;QACtC,MAAMI,UAAUC,OAAOD,OAAO,CAACJ,OAAkCG,GAAG,CAAC,CAAC,CAACG,KAAKC,IAAI;YAC9E,MAAMC,eAAeV,YAAYW,IAAI,CAAC,CAACC,YAAcJ,IAAIK,WAAW,GAAGC,QAAQ,CAACF;YAChF,OAAO;gBAACJ;gBAAKE,eAAe,eAAeT,YAAYQ;aAAK;QAC9D;QACA,OAAOF,OAAOQ,WAAW,CAACT;IAC5B;IAEA,OAAOJ;AACT;AAEA,SAASc,KAAKC,KAAe,EAAEC,OAAe,EAAEC,OAAoB;IAClE,MAAMC,UAAU;QACdH;QACAC;QACAG,WAAW,IAAIC,OAAOC,WAAW;QACjCJ,SAASlB,YAAYkB,WAAW,CAAC;IACnC;IAEA,MAAMK,OAAOC,KAAKC,SAAS,CAACN;IAC5B,IAAIH,UAAU,SAAS;QACrBU,QAAQC,KAAK,CAACJ;QACd;IACF;IAEA,IAAIP,UAAU,QAAQ;QACpBU,QAAQE,IAAI,CAACL;QACb;IACF;IAEAG,QAAQG,GAAG,CAACN;AACd;AAEO,MAAMO,SAAS;IACpBC,OAAO,CAACd,SAAiBC,UAAyBH,KAAK,SAASE,SAASC;IACzEc,MAAM,CAACf,SAAiBC,UAAyBH,KAAK,QAAQE,SAASC;IACvEU,MAAM,CAACX,SAAiBC,UAAyBH,KAAK,QAAQE,SAASC;IACvES,OAAO,CAACV,SAAiBC,UAAyBH,KAAK,SAASE,SAASC;AAC3E"}},
    {"offset": {"line": 97, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/server-observability.ts"],"sourcesContent":["import { logger } from '@/lib/logger';\r\n\r\ntype CaptureContext = {\r\n  tags?: Record<string, string>;\r\n  extra?: Record<string, unknown>;\r\n};\r\n\r\nlet sentryInitPromise: Promise<typeof import('@sentry/node') | null> | null = null;\r\n\r\nasync function getSentry() {\r\n  if (!process.env.SENTRY_DSN) {\r\n    return null;\r\n  }\r\n\r\n  if (!sentryInitPromise) {\r\n    sentryInitPromise = import('@sentry/node')\r\n      .then((sentry) => {\r\n        sentry.init({\r\n          dsn: process.env.SENTRY_DSN,\r\n          environment: process.env.NODE_ENV,\r\n        });\r\n        return sentry;\r\n      })\r\n      .catch(() => null);\r\n  }\r\n\r\n  return sentryInitPromise;\r\n}\r\n\r\nexport async function captureServerException(error: unknown, context?: CaptureContext) {\r\n  logger.error('Unhandled server exception', {\r\n    error: error instanceof Error ? { message: error.message, stack: error.stack } : error,\r\n    ...context,\r\n  });\r\n\r\n  const sentry = await getSentry();\r\n  if (sentry) {\r\n    sentry.withScope((scope) => {\r\n      Object.entries(context?.tags || {}).forEach(([key, value]) => scope.setTag(key, value));\r\n      Object.entries(context?.extra || {}).forEach(([key, value]) => scope.setExtra(key, value));\r\n      sentry.captureException(error);\r\n    });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await fetch(process.env.SENTRY_DSN as string, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        message: error instanceof Error ? error.message : 'Unknown error',\r\n        stack: error instanceof Error ? error.stack : undefined,\r\n        tags: context?.tags,\r\n        extra: context?.extra,\r\n        timestamp: new Date().toISOString(),\r\n      }),\r\n    });\r\n  } catch (captureError) {\r\n    logger.warn('Failed to send server exception to Sentry-compatible endpoint', {\r\n      captureError,\r\n    });\r\n  }\r\n}\r\n"],"names":["sentryInitPromise","getSentry","process","env","SENTRY_DSN","then","sentry","init","dsn","environment","catch","captureServerException","error","context","Error","message","stack","withScope","scope","Object","entries","tags","forEach","key","value","setTag","extra","setExtra","captureException","fetch","method","headers","body","JSON","stringify","undefined","timestamp","Date","toISOString","captureError","warn"],"mappings":";;;;AAAA;;AAOA,IAAIA,oBAA0E;AAE9E,eAAeC;IACb,IAAI,CAACC,QAAQC,GAAG,CAACC,UAAU,EAAE;QAC3B,OAAO;IACT;IAEA,IAAI,CAACJ,mBAAmB;QACtBA,oBAAoB,yHACjBK,IAAI,CAAC,CAACC;YACLA,OAAOC,IAAI,CAAC;gBACVC,KAAKN,QAAQC,GAAG,CAACC,UAAU;gBAC3BK,WAAW;YACb;YACA,OAAOH;QACT,GACCI,KAAK,CAAC,IAAM;IACjB;IAEA,OAAOV;AACT;AAEO,eAAeW,uBAAuBC,KAAc,EAAEC,OAAwB;IACnF,gIAAM,CAACD,KAAK,CAAC,8BAA8B;QACzCA,OAAOA,iBAAiBE,QAAQ;YAAEC,SAASH,MAAMG,OAAO;YAAEC,OAAOJ,MAAMI,KAAK;QAAC,IAAIJ;QACjF,GAAGC,OAAO;IACZ;IAEA,MAAMP,SAAS,MAAML;IACrB,IAAIK,QAAQ;QACVA,OAAOW,SAAS,CAAC,CAACC;YAChBC,OAAOC,OAAO,CAACP,SAASQ,QAAQ,CAAC,GAAGC,OAAO,CAAC,CAAC,CAACC,KAAKC,MAAM,GAAKN,MAAMO,MAAM,CAACF,KAAKC;YAChFL,OAAOC,OAAO,CAACP,SAASa,SAAS,CAAC,GAAGJ,OAAO,CAAC,CAAC,CAACC,KAAKC,MAAM,GAAKN,MAAMS,QAAQ,CAACJ,KAAKC;YACnFlB,OAAOsB,gBAAgB,CAAChB;QAC1B;QACA;IACF;IAEA,IAAI;QACF,MAAMiB,MAAM3B,QAAQC,GAAG,CAACC,UAAU,EAAY;YAC5C0B,QAAQ;YACRC,SAAS;gBAAE,gBAAgB;YAAmB;YAC9CC,MAAMC,KAAKC,SAAS,CAAC;gBACnBnB,SAASH,iBAAiBE,QAAQF,MAAMG,OAAO,GAAG;gBAClDC,OAAOJ,iBAAiBE,QAAQF,MAAMI,KAAK,GAAGmB;gBAC9Cd,MAAMR,SAASQ;gBACfK,OAAOb,SAASa;gBAChBU,WAAW,IAAIC,OAAOC,WAAW;YACnC;QACF;IACF,EAAE,OAAOC,cAAc;QACrB,gIAAM,CAACC,IAAI,CAAC,iEAAiE;YAC3ED;QACF;IACF;AACF"}},
    {"offset": {"line": 160, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/errors.ts"],"sourcesContent":["import { logger } from '@/lib/logger';\r\nimport { captureServerException } from '@/lib/server-observability';\r\n\r\nexport class AppError extends Error {\r\n  public code: string;\r\n  public status: number;\r\n  public details?: any;\r\n\r\n  constructor(code: string, message: string, status: number = 400, details?: any) {\r\n    super(message);\r\n    this.name = 'AppError';\r\n    this.code = code;\r\n    this.status = status;\r\n    this.details = details;\r\n  }\r\n}\r\n\r\nexport function createErrorResponse(error: any) {\r\n  if (error instanceof AppError || (error?.name === 'AppError' && error?.code && error?.message)) {\r\n    return Response.json(\r\n      { success: false, error: { code: error.code, message: error.message, details: error.details } },\r\n      { status: error.status || 400 }\r\n    );\r\n  }\r\n\r\n  if (error?.name === 'ZodError') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: 'VALIDATION_ERROR',\r\n          message: 'Invalid request payload',\r\n          details: error.issues ?? error.errors,\r\n        },\r\n      },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  if (error?.code === 'P2002') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: 'CONFLICT',\r\n          message: 'A record with the same unique value already exists',\r\n          details: error.meta,\r\n        },\r\n      },\r\n      { status: 409 }\r\n    );\r\n  }\r\n\r\n  if (error?.code === 'P2003') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: 'RELATION_ERROR',\r\n          message: 'Related record is missing or invalid',\r\n          details: error.meta,\r\n        },\r\n      },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  logger.error('Unhandled API error', {\r\n    code: error?.code,\r\n    message: error?.message,\r\n  });\r\n  void captureServerException(error, {\r\n    tags: { scope: 'api.createErrorResponse' },\r\n  });\r\n\r\n  if (process.env.NODE_ENV !== 'production') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: error?.code || 'INTERNAL_ERROR',\r\n          message: error?.message || 'Unknown server error',\r\n          details: error?.stack || error,\r\n        },\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n\r\n  return Response.json(\r\n    { success: false, error: { code: 'INTERNAL_ERROR', message: 'An unexpected error occurred' } },\r\n    { status: 500 }\r\n  );\r\n}\r\n"],"names":["AppError","Error","code","status","details","message","name","createErrorResponse","error","Response","json","success","issues","errors","meta","tags","scope","stack"],"mappings":";;;;;;AAAA;AACA;;;AAEO,MAAMA,iBAAiBC;IACrBC,KAAa;IACbC,OAAe;IACfC,QAAc;IAErBJ,YAAYE,IAAY,EAAEG,OAAe,EAAEF,SAAiB,GAAG,EAAEC,OAAa,CAAE;QAC9E,KAAK,CAACC;QACN,IAAI,CAACC,IAAI,GAAG;QACZ,IAAI,CAACJ,IAAI,GAAGA;QACZ,IAAI,CAACC,MAAM,GAAGA;QACd,IAAI,CAACC,OAAO,GAAGA;IACjB;AACF;AAEO,SAASG,oBAAoBC,KAAU;IAC5C,IAAIA,iBAAiBR,YAAaQ,OAAOF,SAAS,cAAcE,OAAON,QAAQM,OAAOH,SAAU;QAC9F,OAAOI,SAASC,IAAI,CAClB;YAAEC,SAAS;YAAOH,OAAO;gBAAEN,MAAMM,MAAMN,IAAI;gBAAEG,SAASG,MAAMH,OAAO;gBAAED,SAASI,MAAMJ,OAAO;YAAC;QAAE,GAC9F;YAAED,QAAQK,MAAML,MAAM,IAAI;QAAI;IAElC;IAEA,IAAIK,OAAOF,SAAS,YAAY;QAC9B,OAAOG,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAM;gBACNG,SAAS;gBACTD,SAASI,MAAMI,MAAM,IAAIJ,MAAMK,MAAM;YACvC;QACF,GACA;YAAEV,QAAQ;QAAI;IAElB;IAEA,IAAIK,OAAON,SAAS,SAAS;QAC3B,OAAOO,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAM;gBACNG,SAAS;gBACTD,SAASI,MAAMM,IAAI;YACrB;QACF,GACA;YAAEX,QAAQ;QAAI;IAElB;IAEA,IAAIK,OAAON,SAAS,SAAS;QAC3B,OAAOO,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAM;gBACNG,SAAS;gBACTD,SAASI,MAAMM,IAAI;YACrB;QACF,GACA;YAAEX,QAAQ;QAAI;IAElB;IAEA,gIAAM,CAACK,KAAK,CAAC,uBAAuB;QAClCN,MAAMM,OAAON;QACbG,SAASG,OAAOH;IAClB;IACA,KAAK,IAAA,iKAAsB,EAACG,OAAO;QACjCO,MAAM;YAAEC,OAAO;QAA0B;IAC3C;IAEA,wCAA2C;QACzC,OAAOP,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAMM,OAAON,QAAQ;gBACrBG,SAASG,OAAOH,WAAW;gBAC3BD,SAASI,OAAOS,SAAST;YAC3B;QACF,GACA;YAAEL,QAAQ;QAAI;IAElB;;;AAMF"}},
    {"offset": {"line": 259, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/integrations/email/provider.ts"],"sourcesContent":["import { AppError } from '@/lib/errors';\r\nimport { logger } from '@/lib/logger';\r\n\r\nexport type EmailMessage = {\r\n  to: string;\r\n  subject: string;\r\n  html: string;\r\n  from?: string;\r\n};\r\n\r\nconst sentInWindow = new Map<string, { count: number; resetAt: number }>();\r\n\r\nfunction checkQuota(recipient: string) {\r\n  const now = Date.now();\r\n  const current = sentInWindow.get(recipient);\r\n  const resetAt = now + 60_000;\r\n\r\n  if (!current || current.resetAt <= now) {\r\n    sentInWindow.set(recipient, { count: 1, resetAt });\r\n    return;\r\n  }\r\n\r\n  if (current.count >= 10) {\r\n    throw new AppError('EMAIL_RATE_LIMITED', 'Too many emails for recipient in current window', 429);\r\n  }\r\n\r\n  sentInWindow.set(recipient, { count: current.count + 1, resetAt: current.resetAt });\r\n}\r\n\r\nexport async function sendEmail(message: EmailMessage) {\r\n  const apiKey = process.env.RESEND_API_KEY;\r\n  if (!apiKey) {\r\n    logger.warn('Email provider not configured; skipping email send', {\r\n      to: message.to,\r\n      subject: message.subject,\r\n    });\r\n    return { queued: false, skipped: true };\r\n  }\r\n\r\n  checkQuota(message.to);\r\n\r\n  const response = await fetch('https://api.resend.com/emails', {\r\n    method: 'POST',\r\n    headers: {\r\n      Authorization: `Bearer ${apiKey}`,\r\n      'Content-Type': 'application/json',\r\n    },\r\n    body: JSON.stringify({\r\n      from: message.from || 'FarmOps <no-reply@farmops.local>',\r\n      to: [message.to],\r\n      subject: message.subject,\r\n      html: message.html,\r\n    }),\r\n  });\r\n\r\n  if (!response.ok) {\r\n    const payload = await response.text();\r\n    throw new AppError('EMAIL_SEND_FAILED', 'Failed to send email', 502, { payload });\r\n  }\r\n\r\n  return { queued: true, skipped: false };\r\n}\r\n"],"names":["sentInWindow","Map","checkQuota","recipient","now","Date","current","get","resetAt","set","count","sendEmail","message","apiKey","process","env","RESEND_API_KEY","warn","to","subject","queued","skipped","response","fetch","method","headers","Authorization","body","JSON","stringify","from","html","ok","payload","text"],"mappings":";;;;AAAA;AACA;;;AASA,MAAMA,eAAe,IAAIC;AAEzB,SAASC,WAAWC,SAAiB;IACnC,MAAMC,MAAMC,KAAKD,GAAG;IACpB,MAAME,UAAUN,aAAaO,GAAG,CAACJ;IACjC,MAAMK,UAAUJ,MAAM;IAEtB,IAAI,CAACE,WAAWA,QAAQE,OAAO,IAAIJ,KAAK;QACtCJ,aAAaS,GAAG,CAACN,WAAW;YAAEO,OAAO;YAAGF;QAAQ;QAChD;IACF;IAEA,IAAIF,QAAQI,KAAK,IAAI,IAAI;QACvB,MAAM,IAAI,kIAAQ,CAAC,sBAAsB,mDAAmD;IAC9F;IAEAV,aAAaS,GAAG,CAACN,WAAW;QAAEO,OAAOJ,QAAQI,KAAK,GAAG;QAAGF,SAASF,QAAQE,OAAO;IAAC;AACnF;AAEO,eAAeG,UAAUC,OAAqB;IACnD,MAAMC,SAASC,QAAQC,GAAG,CAACC,cAAc;IACzC,IAAI,CAACH,QAAQ;QACX,gIAAM,CAACI,IAAI,CAAC,sDAAsD;YAChEC,IAAIN,QAAQM,EAAE;YACdC,SAASP,QAAQO,OAAO;QAC1B;QACA,OAAO;YAAEC,QAAQ;YAAOC,SAAS;QAAK;IACxC;IAEAnB,WAAWU,QAAQM,EAAE;IAErB,MAAMI,WAAW,MAAMC,MAAM,iCAAiC;QAC5DC,QAAQ;QACRC,SAAS;YACPC,eAAe,CAAC,OAAO,EAAEb,QAAQ;YACjC,gBAAgB;QAClB;QACAc,MAAMC,KAAKC,SAAS,CAAC;YACnBC,MAAMlB,QAAQkB,IAAI,IAAI;YACtBZ,IAAI;gBAACN,QAAQM,EAAE;aAAC;YAChBC,SAASP,QAAQO,OAAO;YACxBY,MAAMnB,QAAQmB,IAAI;QACpB;IACF;IAEA,IAAI,CAACT,SAASU,EAAE,EAAE;QAChB,MAAMC,UAAU,MAAMX,SAASY,IAAI;QACnC,MAAM,IAAI,kIAAQ,CAAC,qBAAqB,wBAAwB,KAAK;YAAED;QAAQ;IACjF;IAEA,OAAO;QAAEb,QAAQ;QAAMC,SAAS;IAAM;AACxC"}},
    {"offset": {"line": 330, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/permissions.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { AppError } from './errors';\r\n\r\nexport type FarmPermission =\r\n  | 'finance:read'\r\n  | 'finance:write'\r\n  | 'finance:approve'\r\n  | 'updates:read'\r\n  | 'updates:write'\r\n  | 'digest:read'\r\n  | 'monitoring:read'\r\n  | 'monitoring:write'\r\n  | 'incident:read'\r\n  | 'incident:write'\r\n  | 'vendor:read'\r\n  | 'vendor:write'\r\n  | 'procurement:read'\r\n  | 'procurement:write'\r\n  | 'payroll:read'\r\n  | 'payroll:write'\r\n  | 'payroll:approve'\r\n  | 'payroll:pay';\r\n\r\ntype FarmRole = 'OWNER' | 'MANAGER' | 'WORKER';\r\n\r\nconst roleMatrix: Record<FarmRole, FarmPermission[]> = {\r\n  OWNER: [\r\n    'finance:read',\r\n    'finance:write',\r\n    'finance:approve',\r\n    'updates:read',\r\n    'updates:write',\r\n    'digest:read',\r\n    'monitoring:read',\r\n    'monitoring:write',\r\n    'incident:read',\r\n    'incident:write',\r\n    'vendor:read',\r\n    'vendor:write',\r\n    'procurement:read',\r\n    'procurement:write',\r\n    'payroll:read',\r\n    'payroll:write',\r\n    'payroll:approve',\r\n    'payroll:pay',\r\n  ],\r\n  MANAGER: [\r\n    'finance:read',\r\n    'finance:write',\r\n    'updates:read',\r\n    'updates:write',\r\n    'digest:read',\r\n    'monitoring:read',\r\n    'monitoring:write',\r\n    'incident:read',\r\n    'incident:write',\r\n    'vendor:read',\r\n    'vendor:write',\r\n    'procurement:read',\r\n    'procurement:write',\r\n    'payroll:read',\r\n    'payroll:write',\r\n  ],\r\n  WORKER: ['updates:read', 'updates:write', 'incident:read', 'incident:write', 'procurement:read'],\r\n};\r\n\r\nexport function getRequestRole(request: NextRequest): FarmRole {\r\n  const headerRole = request.headers.get('x-farm-role');\r\n  if (headerRole === 'OWNER' || headerRole === 'MANAGER' || headerRole === 'WORKER') {\r\n    return headerRole;\r\n  }\r\n\r\n  return 'MANAGER';\r\n}\r\n\r\nexport function getRequestUserId(request: NextRequest): string {\r\n  return request.headers.get('x-user-id') || 'user_id_from_session';\r\n}\r\n\r\nexport function requirePermission(request: NextRequest, permission: FarmPermission) {\r\n  const role = getRequestRole(request);\r\n  if (!roleMatrix[role].includes(permission)) {\r\n    throw new AppError('FORBIDDEN', 'You do not have permission for this action', 403);\r\n  }\r\n}\r\n"],"names":["roleMatrix","OWNER","MANAGER","WORKER","getRequestRole","request","headerRole","headers","get","getRequestUserId","requirePermission","permission","role","includes"],"mappings":";;;;;;;;AACA;;AAwBA,MAAMA,aAAiD;IACrDC,OAAO;QACL;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACDC,SAAS;QACP;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACDC,QAAQ;QAAC;QAAgB;QAAiB;QAAiB;QAAkB;KAAmB;AAClG;AAEO,SAASC,eAAeC,OAAoB;IACjD,MAAMC,aAAaD,QAAQE,OAAO,CAACC,GAAG,CAAC;IACvC,IAAIF,eAAe,WAAWA,eAAe,aAAaA,eAAe,UAAU;QACjF,OAAOA;IACT;IAEA,OAAO;AACT;AAEO,SAASG,iBAAiBJ,OAAoB;IACnD,OAAOA,QAAQE,OAAO,CAACC,GAAG,CAAC,gBAAgB;AAC7C;AAEO,SAASE,kBAAkBL,OAAoB,EAAEM,UAA0B;IAChF,MAAMC,OAAOR,eAAeC;IAC5B,IAAI,CAACL,UAAU,CAACY,KAAK,CAACC,QAAQ,CAACF,aAAa;QAC1C,MAAM,IAAI,kIAAQ,CAAC,aAAa,8CAA8C;IAChF;AACF"}},
    {"offset": {"line": 406, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\n\r\nconst globalForPrisma = globalThis as unknown as { prisma: PrismaClient };\r\n\r\nexport const prisma = globalForPrisma.prisma || new PrismaClient();\r\n\r\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\r\n"],"names":["globalForPrisma","globalThis","prisma"],"mappings":";;;;AAAA;;AAEA,MAAMA,kBAAkBC;AAEjB,MAAMC,SAASF,gBAAgBE,MAAM,IAAI,IAAI,sMAAY;AAEhE,wCAA2CF,gBAAgBE,MAAM,GAAGA"}},
    {"offset": {"line": 419, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/env.ts"],"sourcesContent":["import { z } from 'zod';\r\n\r\nconst envSchema = z.object({\r\n  DATABASE_URL: z.string().url(),\r\n  APP_SECRET: z.string().min(32),\r\n  APP_URL: z.string().url().optional(),\r\n  UPSTASH_REDIS_URL: z.string().url().optional(),\r\n  UPSTASH_REDIS_TOKEN: z.string().optional(),\r\n  UPSTASH_QSTASH_URL: z.string().url().optional(),\r\n  UPSTASH_QSTASH_TOKEN: z.string().optional(),\r\n  RESEND_API_KEY: z.string().optional(),\r\n  CLOUDFLARE_R2_ACCESS_KEY: z.string().optional(),\r\n  CLOUDFLARE_R2_SECRET_KEY: z.string().optional(),\r\n  CLOUDFLARE_R2_BUCKET: z.string().optional(),\r\n  CLOUDFLARE_R2_ENDPOINT: z.string().url().optional(),\r\n  CLOUDFLARE_R2_PUBLIC_BASE_URL: z.string().url().optional(),\r\n  VAPID_PUBLIC_KEY: z.string().optional(),\r\n  VAPID_PRIVATE_KEY: z.string().optional(),\r\n  PAYSTACK_SECRET_KEY: z.string().optional(),\r\n  HUBTEL_CLIENT_ID: z.string().optional(),\r\n  HUBTEL_CLIENT_SECRET: z.string().optional(),\r\n  CRON_SECRET: z.string().optional(),\r\n  SENTRY_DSN: z.string().url().optional(),\r\n});\r\n\r\nconst parsedEnv = envSchema.safeParse(process.env);\r\n\r\nif (!parsedEnv.success && process.env.NODE_ENV === 'production') {\r\n  console.error('❌ Environment validation failed:', parsedEnv.error.format());\r\n  throw new Error('Invalid environment configuration');\r\n}\r\n\r\nexport const env = (parsedEnv.success ? parsedEnv.data : process.env) as z.infer<typeof envSchema>;\r\n\r\nexport function validateEnv() {\r\n  if (!parsedEnv.success) {\r\n    console.warn('⚠️ Environment validation warnings:', parsedEnv.error.flatten().fieldErrors);\r\n    return;\r\n  }\r\n\r\n  const checks = {\r\n    storage: Boolean(env.CLOUDFLARE_R2_ACCESS_KEY && env.CLOUDFLARE_R2_SECRET_KEY && env.CLOUDFLARE_R2_BUCKET && env.CLOUDFLARE_R2_ENDPOINT),\r\n    redis: Boolean(env.UPSTASH_REDIS_URL && env.UPSTASH_REDIS_TOKEN),\r\n    qstash: Boolean(env.UPSTASH_QSTASH_URL && env.UPSTASH_QSTASH_TOKEN),\r\n    email: Boolean(env.RESEND_API_KEY),\r\n    push: Boolean(env.VAPID_PUBLIC_KEY && env.VAPID_PRIVATE_KEY),\r\n    payments: Boolean(env.PAYSTACK_SECRET_KEY || (env.HUBTEL_CLIENT_ID && env.HUBTEL_CLIENT_SECRET)),\r\n    sentry: Boolean(env.SENTRY_DSN),\r\n  };\r\n\r\n  const missingOptional = Object.entries(checks)\r\n    .filter(([, configured]) => !configured)\r\n    .map(([name]) => name);\r\n\r\n  if (missingOptional.length > 0) {\r\n    console.warn(`⚠️ Optional integrations not configured: ${missingOptional.join(', ')}`);\r\n  } else {\r\n    console.log('✅ Environment validated');\r\n  }\r\n}\r\n"],"names":["envSchema","object","DATABASE_URL","string","url","APP_SECRET","min","APP_URL","optional","UPSTASH_REDIS_URL","UPSTASH_REDIS_TOKEN","UPSTASH_QSTASH_URL","UPSTASH_QSTASH_TOKEN","RESEND_API_KEY","CLOUDFLARE_R2_ACCESS_KEY","CLOUDFLARE_R2_SECRET_KEY","CLOUDFLARE_R2_BUCKET","CLOUDFLARE_R2_ENDPOINT","CLOUDFLARE_R2_PUBLIC_BASE_URL","VAPID_PUBLIC_KEY","VAPID_PRIVATE_KEY","PAYSTACK_SECRET_KEY","HUBTEL_CLIENT_ID","HUBTEL_CLIENT_SECRET","CRON_SECRET","SENTRY_DSN","parsedEnv","safeParse","process","env","success","data","validateEnv","console","warn","error","flatten","fieldErrors","checks","storage","Boolean","redis","qstash","email","push","payments","sentry","missingOptional","Object","entries","filter","configured","map","name","length","join","log"],"mappings":";;;;;;AAAA;;AAEA,MAAMA,YAAY,yKAAC,CAACC,MAAM,CAAC;IACzBC,cAAc,yKAAC,CAACC,MAAM,GAAGC,GAAG;IAC5BC,YAAY,yKAAC,CAACF,MAAM,GAAGG,GAAG,CAAC;IAC3BC,SAAS,yKAAC,CAACJ,MAAM,GAAGC,GAAG,GAAGI,QAAQ;IAClCC,mBAAmB,yKAAC,CAACN,MAAM,GAAGC,GAAG,GAAGI,QAAQ;IAC5CE,qBAAqB,yKAAC,CAACP,MAAM,GAAGK,QAAQ;IACxCG,oBAAoB,yKAAC,CAACR,MAAM,GAAGC,GAAG,GAAGI,QAAQ;IAC7CI,sBAAsB,yKAAC,CAACT,MAAM,GAAGK,QAAQ;IACzCK,gBAAgB,yKAAC,CAACV,MAAM,GAAGK,QAAQ;IACnCM,0BAA0B,yKAAC,CAACX,MAAM,GAAGK,QAAQ;IAC7CO,0BAA0B,yKAAC,CAACZ,MAAM,GAAGK,QAAQ;IAC7CQ,sBAAsB,yKAAC,CAACb,MAAM,GAAGK,QAAQ;IACzCS,wBAAwB,yKAAC,CAACd,MAAM,GAAGC,GAAG,GAAGI,QAAQ;IACjDU,+BAA+B,yKAAC,CAACf,MAAM,GAAGC,GAAG,GAAGI,QAAQ;IACxDW,kBAAkB,yKAAC,CAAChB,MAAM,GAAGK,QAAQ;IACrCY,mBAAmB,yKAAC,CAACjB,MAAM,GAAGK,QAAQ;IACtCa,qBAAqB,yKAAC,CAAClB,MAAM,GAAGK,QAAQ;IACxCc,kBAAkB,yKAAC,CAACnB,MAAM,GAAGK,QAAQ;IACrCe,sBAAsB,yKAAC,CAACpB,MAAM,GAAGK,QAAQ;IACzCgB,aAAa,yKAAC,CAACrB,MAAM,GAAGK,QAAQ;IAChCiB,YAAY,yKAAC,CAACtB,MAAM,GAAGC,GAAG,GAAGI,QAAQ;AACvC;AAEA,MAAMkB,YAAY1B,UAAU2B,SAAS,CAACC,QAAQC,GAAG;AAEjD;;AAKO,MAAMA,MAAOH,UAAUI,OAAO,GAAGJ,UAAUK,IAAI,GAAGH,QAAQC,GAAG;AAE7D,SAASG;IACd,IAAI,CAACN,UAAUI,OAAO,EAAE;QACtBG,QAAQC,IAAI,CAAC,uCAAuCR,UAAUS,KAAK,CAACC,OAAO,GAAGC,WAAW;QACzF;IACF;IAEA,MAAMC,SAAS;QACbC,SAASC,QAAQX,IAAIf,wBAAwB,IAAIe,IAAId,wBAAwB,IAAIc,IAAIb,oBAAoB,IAAIa,IAAIZ,sBAAsB;QACvIwB,OAAOD,QAAQX,IAAIpB,iBAAiB,IAAIoB,IAAInB,mBAAmB;QAC/DgC,QAAQF,QAAQX,IAAIlB,kBAAkB,IAAIkB,IAAIjB,oBAAoB;QAClE+B,OAAOH,QAAQX,IAAIhB,cAAc;QACjC+B,MAAMJ,QAAQX,IAAIV,gBAAgB,IAAIU,IAAIT,iBAAiB;QAC3DyB,UAAUL,QAAQX,IAAIR,mBAAmB,IAAKQ,IAAIP,gBAAgB,IAAIO,IAAIN,oBAAoB;QAC9FuB,QAAQN,QAAQX,IAAIJ,UAAU;IAChC;IAEA,MAAMsB,kBAAkBC,OAAOC,OAAO,CAACX,QACpCY,MAAM,CAAC,CAAC,GAAGC,WAAW,GAAK,CAACA,YAC5BC,GAAG,CAAC,CAAC,CAACC,KAAK,GAAKA;IAEnB,IAAIN,gBAAgBO,MAAM,GAAG,GAAG;QAC9BrB,QAAQC,IAAI,CAAC,CAAC,yCAAyC,EAAEa,gBAAgBQ,IAAI,CAAC,OAAO;IACvF,OAAO;QACLtB,QAAQuB,GAAG,CAAC;IACd;AACF"}},
    {"offset": {"line": 478, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/app/api/farms/%5BfarmId%5D/invites/route.ts"],"sourcesContent":["import { randomBytes } from 'node:crypto';\r\nimport { NextRequest } from 'next/server';\r\nimport { z } from 'zod';\r\nimport { AppError, createErrorResponse } from '@/lib/errors';\r\nimport { sendEmail } from '@/lib/integrations/email/provider';\r\nimport { getRequestRole, getRequestUserId } from '@/lib/permissions';\r\nimport { prisma } from '@/lib/prisma';\r\nimport { env } from '@/lib/env';\r\n\r\nconst invitationRepo = (prisma as any).invitation as {\r\n  findMany: (args: any) => Promise<any[]>;\r\n  upsert: (args: any) => Promise<any>;\r\n};\r\n\r\nconst inviteSchema = z.object({\r\n  email: z.string().email(),\r\n  role: z.enum(['OWNER', 'MANAGER', 'WORKER']),\r\n});\r\n\r\nfunction ensureInvitePermission(request: NextRequest) {\r\n  if (getRequestRole(request) === 'WORKER') {\r\n    throw new AppError('FORBIDDEN', 'Only owners and managers can invite users.', 403);\r\n  }\r\n}\r\n\r\nfunction buildInviteLink(request: NextRequest, token: string) {\r\n  const baseUrl = env.APP_URL || new URL(request.url).origin;\r\n  return `${baseUrl}/auth/invite/${token}`;\r\n}\r\n\r\nfunction inviteEmailHtml(params: { inviteLink: string; farmName: string; role: 'OWNER' | 'MANAGER' | 'WORKER' }) {\r\n  return `\r\n    <div style=\"font-family:Arial,sans-serif;line-height:1.5;color:#111\">\r\n      <h2 style=\"margin:0 0 12px\">You are invited to ${params.farmName}</h2>\r\n      <p style=\"margin:0 0 12px\">You were invited as a <strong>${params.role}</strong>.</p>\r\n      <p style=\"margin:0 0 16px\">Click the link below to create your account and set your password:</p>\r\n      <p style=\"margin:0 0 20px\"><a href=\"${params.inviteLink}\">${params.inviteLink}</a></p>\r\n      <p style=\"margin:0\">If you did not expect this invite, you can ignore this email.</p>\r\n    </div>\r\n  `;\r\n}\r\n\r\nexport async function GET(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ farmId: string }> }\r\n) {\r\n  try {\r\n    ensureInvitePermission(request);\r\n    const { farmId } = await context.params;\r\n\r\n    const invitations = await invitationRepo.findMany({\r\n      where: {\r\n        farmId,\r\n        acceptedAt: null,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        role: true,\r\n        expiresAt: true,\r\n        createdAt: true,\r\n      },\r\n    });\r\n\r\n    return Response.json({ success: true, data: invitations });\r\n  } catch (error) {\r\n    return createErrorResponse(error);\r\n  }\r\n}\r\n\r\nexport async function POST(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ farmId: string }> }\r\n) {\r\n  try {\r\n    ensureInvitePermission(request);\r\n    const { farmId } = await context.params;\r\n    const input = inviteSchema.parse(await request.json());\r\n    const inviterUserId = getRequestUserId(request);\r\n    const email = input.email.toLowerCase();\r\n    const inviter = await prisma.user.findUnique({\r\n      where: { id: inviterUserId },\r\n      select: { id: true },\r\n    });\r\n    const safeInvitedByUserId = inviter?.id ?? null;\r\n\r\n    const farm = await prisma.farm.findUnique({\r\n      where: { id: farmId },\r\n      select: { name: true },\r\n    });\r\n\r\n    if (!farm) {\r\n      throw new AppError('FARM_NOT_FOUND', 'Farm not found.', 404);\r\n    }\r\n\r\n    const userWithMembership = await prisma.user.findUnique({\r\n      where: { email },\r\n      include: {\r\n        memberships: {\r\n          where: { farmId },\r\n          take: 1,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (userWithMembership?.memberships.length) {\r\n      throw new AppError('ALREADY_MEMBER', 'This email already has access to this farm.', 409);\r\n    }\r\n\r\n    const token = randomBytes(32).toString('hex');\r\n    const expiresAt = new Date(Date.now() + 1000 * 60 * 60 * 24 * 7);\r\n\r\n    const invitation = await invitationRepo.upsert({\r\n      where: {\r\n        farmId_email: {\r\n          farmId,\r\n          email,\r\n        },\r\n      },\r\n      update: {\r\n        role: input.role,\r\n        token,\r\n        expiresAt,\r\n        acceptedAt: null,\r\n        invitedByUserId: safeInvitedByUserId,\r\n      },\r\n      create: {\r\n        farmId,\r\n        email,\r\n        role: input.role,\r\n        token,\r\n        expiresAt,\r\n        invitedByUserId: safeInvitedByUserId,\r\n      },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        role: true,\r\n        expiresAt: true,\r\n      },\r\n    });\r\n\r\n    await sendEmail({\r\n      to: invitation.email,\r\n      subject: `You are invited to join ${farm.name}`,\r\n      html: inviteEmailHtml({\r\n        inviteLink: buildInviteLink(request, token),\r\n        farmName: farm.name,\r\n        role: invitation.role,\r\n      }),\r\n    });\r\n\r\n    return Response.json({\r\n      success: true,\r\n      data: {\r\n        ...invitation,\r\n        sent: true,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    return createErrorResponse(error);\r\n  }\r\n}\r\n"],"names":["invitationRepo","invitation","inviteSchema","object","email","string","role","enum","ensureInvitePermission","request","buildInviteLink","token","baseUrl","APP_URL","URL","url","origin","inviteEmailHtml","params","farmName","inviteLink","GET","context","farmId","invitations","findMany","where","acceptedAt","orderBy","createdAt","select","id","expiresAt","Response","json","success","data","error","POST","input","parse","inviterUserId","toLowerCase","inviter","user","findUnique","safeInvitedByUserId","farm","name","userWithMembership","include","memberships","take","length","toString","Date","now","upsert","farmId_email","update","invitedByUserId","create","to","subject","html","sent"],"mappings":"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"}}]
}