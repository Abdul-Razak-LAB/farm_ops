{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/logger.ts"],"sourcesContent":["type LogLevel = 'debug' | 'info' | 'warn' | 'error';\r\n\r\ntype LogContext = Record<string, unknown>;\r\n\r\nconst REDACT_KEYS = ['password', 'token', 'authorization', 'cookie', 'email', 'phone', 'secret'];\r\n\r\nfunction redactValue(value: unknown): unknown {\r\n  if (Array.isArray(value)) {\r\n    return value.map(redactValue);\r\n  }\r\n\r\n  if (value && typeof value === 'object') {\r\n    const entries = Object.entries(value as Record<string, unknown>).map(([key, val]) => {\r\n      const shouldRedact = REDACT_KEYS.some((redactKey) => key.toLowerCase().includes(redactKey));\r\n      return [key, shouldRedact ? '[REDACTED]' : redactValue(val)];\r\n    });\r\n    return Object.fromEntries(entries);\r\n  }\r\n\r\n  return value;\r\n}\r\n\r\nfunction emit(level: LogLevel, message: string, context?: LogContext) {\r\n  const payload = {\r\n    level,\r\n    message,\r\n    timestamp: new Date().toISOString(),\r\n    context: redactValue(context || {}),\r\n  };\r\n\r\n  const line = JSON.stringify(payload);\r\n  if (level === 'error') {\r\n    console.error(line);\r\n    return;\r\n  }\r\n\r\n  if (level === 'warn') {\r\n    console.warn(line);\r\n    return;\r\n  }\r\n\r\n  console.log(line);\r\n}\r\n\r\nexport const logger = {\r\n  debug: (message: string, context?: LogContext) => emit('debug', message, context),\r\n  info: (message: string, context?: LogContext) => emit('info', message, context),\r\n  warn: (message: string, context?: LogContext) => emit('warn', message, context),\r\n  error: (message: string, context?: LogContext) => emit('error', message, context),\r\n};\r\n"],"names":["REDACT_KEYS","redactValue","value","Array","isArray","map","entries","Object","key","val","shouldRedact","some","redactKey","toLowerCase","includes","fromEntries","emit","level","message","context","payload","timestamp","Date","toISOString","line","JSON","stringify","console","error","warn","log","logger","debug","info"],"mappings":";;;;AAIA,MAAMA,cAAc;IAAC;IAAY;IAAS;IAAiB;IAAU;IAAS;IAAS;CAAS;AAEhG,SAASC,YAAYC,KAAc;IACjC,IAAIC,MAAMC,OAAO,CAACF,QAAQ;QACxB,OAAOA,MAAMG,GAAG,CAACJ;IACnB;IAEA,IAAIC,SAAS,OAAOA,UAAU,UAAU;QACtC,MAAMI,UAAUC,OAAOD,OAAO,CAACJ,OAAkCG,GAAG,CAAC,CAAC,CAACG,KAAKC,IAAI;YAC9E,MAAMC,eAAeV,YAAYW,IAAI,CAAC,CAACC,YAAcJ,IAAIK,WAAW,GAAGC,QAAQ,CAACF;YAChF,OAAO;gBAACJ;gBAAKE,eAAe,eAAeT,YAAYQ;aAAK;QAC9D;QACA,OAAOF,OAAOQ,WAAW,CAACT;IAC5B;IAEA,OAAOJ;AACT;AAEA,SAASc,KAAKC,KAAe,EAAEC,OAAe,EAAEC,OAAoB;IAClE,MAAMC,UAAU;QACdH;QACAC;QACAG,WAAW,IAAIC,OAAOC,WAAW;QACjCJ,SAASlB,YAAYkB,WAAW,CAAC;IACnC;IAEA,MAAMK,OAAOC,KAAKC,SAAS,CAACN;IAC5B,IAAIH,UAAU,SAAS;QACrBU,QAAQC,KAAK,CAACJ;QACd;IACF;IAEA,IAAIP,UAAU,QAAQ;QACpBU,QAAQE,IAAI,CAACL;QACb;IACF;IAEAG,QAAQG,GAAG,CAACN;AACd;AAEO,MAAMO,SAAS;IACpBC,OAAO,CAACd,SAAiBC,UAAyBH,KAAK,SAASE,SAASC;IACzEc,MAAM,CAACf,SAAiBC,UAAyBH,KAAK,QAAQE,SAASC;IACvEU,MAAM,CAACX,SAAiBC,UAAyBH,KAAK,QAAQE,SAASC;IACvES,OAAO,CAACV,SAAiBC,UAAyBH,KAAK,SAASE,SAASC;AAC3E"}},
    {"offset": {"line": 97, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/server-observability.ts"],"sourcesContent":["import { logger } from '@/lib/logger';\r\n\r\ntype CaptureContext = {\r\n  tags?: Record<string, string>;\r\n  extra?: Record<string, unknown>;\r\n};\r\n\r\nexport async function captureServerException(error: unknown, context?: CaptureContext) {\r\n  logger.error('Unhandled server exception', {\r\n    error: error instanceof Error ? { message: error.message, stack: error.stack } : error,\r\n    ...context,\r\n  });\r\n\r\n  const sentryDsn = process.env.SENTRY_DSN;\r\n  if (!sentryDsn) return;\r\n\r\n  try {\r\n    await fetch(sentryDsn, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        message: error instanceof Error ? error.message : 'Unknown error',\r\n        stack: error instanceof Error ? error.stack : undefined,\r\n        tags: context?.tags,\r\n        extra: context?.extra,\r\n        timestamp: new Date().toISOString(),\r\n      }),\r\n    });\r\n  } catch (captureError) {\r\n    logger.warn('Failed to send server exception to Sentry-compatible endpoint', {\r\n      captureError,\r\n    });\r\n  }\r\n}\r\n"],"names":["captureServerException","error","context","Error","message","stack","sentryDsn","process","env","SENTRY_DSN","fetch","method","headers","body","JSON","stringify","undefined","tags","extra","timestamp","Date","toISOString","captureError","warn"],"mappings":";;;;AAAA;;AAOO,eAAeA,uBAAuBC,KAAc,EAAEC,OAAwB;IACnF,gIAAM,CAACD,KAAK,CAAC,8BAA8B;QACzCA,OAAOA,iBAAiBE,QAAQ;YAAEC,SAASH,MAAMG,OAAO;YAAEC,OAAOJ,MAAMI,KAAK;QAAC,IAAIJ;QACjF,GAAGC,OAAO;IACZ;IAEA,MAAMI,YAAYC,QAAQC,GAAG,CAACC,UAAU;IACxC,IAAI,CAACH,WAAW;IAEhB,IAAI;QACF,MAAMI,MAAMJ,WAAW;YACrBK,QAAQ;YACRC,SAAS;gBAAE,gBAAgB;YAAmB;YAC9CC,MAAMC,KAAKC,SAAS,CAAC;gBACnBX,SAASH,iBAAiBE,QAAQF,MAAMG,OAAO,GAAG;gBAClDC,OAAOJ,iBAAiBE,QAAQF,MAAMI,KAAK,GAAGW;gBAC9CC,MAAMf,SAASe;gBACfC,OAAOhB,SAASgB;gBAChBC,WAAW,IAAIC,OAAOC,WAAW;YACnC;QACF;IACF,EAAE,OAAOC,cAAc;QACrB,gIAAM,CAACC,IAAI,CAAC,iEAAiE;YAC3ED;QACF;IACF;AACF"}},
    {"offset": {"line": 137, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/errors.ts"],"sourcesContent":["import { logger } from '@/lib/logger';\r\nimport { captureServerException } from '@/lib/server-observability';\r\n\r\nexport class AppError extends Error {\r\n  public code: string;\r\n  public status: number;\r\n  public details?: any;\r\n\r\n  constructor(code: string, message: string, status: number = 400, details?: any) {\r\n    super(message);\r\n    this.name = 'AppError';\r\n    this.code = code;\r\n    this.status = status;\r\n    this.details = details;\r\n  }\r\n}\r\n\r\nexport function createErrorResponse(error: any) {\r\n  if (error instanceof AppError || (error?.name === 'AppError' && error?.code && error?.message)) {\r\n    return Response.json(\r\n      { success: false, error: { code: error.code, message: error.message, details: error.details } },\r\n      { status: error.status || 400 }\r\n    );\r\n  }\r\n\r\n  if (error?.name === 'ZodError') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: 'VALIDATION_ERROR',\r\n          message: 'Invalid request payload',\r\n          details: error.issues ?? error.errors,\r\n        },\r\n      },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  if (error?.code === 'P2002') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: 'CONFLICT',\r\n          message: 'A record with the same unique value already exists',\r\n          details: error.meta,\r\n        },\r\n      },\r\n      { status: 409 }\r\n    );\r\n  }\r\n\r\n  if (error?.code === 'P2003') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: 'RELATION_ERROR',\r\n          message: 'Related record is missing or invalid',\r\n          details: error.meta,\r\n        },\r\n      },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  logger.error('Unhandled API error', {\r\n    code: error?.code,\r\n    message: error?.message,\r\n  });\r\n  void captureServerException(error, {\r\n    tags: { scope: 'api.createErrorResponse' },\r\n  });\r\n\r\n  if (process.env.NODE_ENV !== 'production') {\r\n    return Response.json(\r\n      {\r\n        success: false,\r\n        error: {\r\n          code: error?.code || 'INTERNAL_ERROR',\r\n          message: error?.message || 'Unknown server error',\r\n          details: error?.stack || error,\r\n        },\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n\r\n  return Response.json(\r\n    { success: false, error: { code: 'INTERNAL_ERROR', message: 'An unexpected error occurred' } },\r\n    { status: 500 }\r\n  );\r\n}\r\n"],"names":["AppError","Error","code","status","details","message","name","createErrorResponse","error","Response","json","success","issues","errors","meta","tags","scope","stack"],"mappings":";;;;;;AAAA;AACA;;;AAEO,MAAMA,iBAAiBC;IACrBC,KAAa;IACbC,OAAe;IACfC,QAAc;IAErBJ,YAAYE,IAAY,EAAEG,OAAe,EAAEF,SAAiB,GAAG,EAAEC,OAAa,CAAE;QAC9E,KAAK,CAACC;QACN,IAAI,CAACC,IAAI,GAAG;QACZ,IAAI,CAACJ,IAAI,GAAGA;QACZ,IAAI,CAACC,MAAM,GAAGA;QACd,IAAI,CAACC,OAAO,GAAGA;IACjB;AACF;AAEO,SAASG,oBAAoBC,KAAU;IAC5C,IAAIA,iBAAiBR,YAAaQ,OAAOF,SAAS,cAAcE,OAAON,QAAQM,OAAOH,SAAU;QAC9F,OAAOI,SAASC,IAAI,CAClB;YAAEC,SAAS;YAAOH,OAAO;gBAAEN,MAAMM,MAAMN,IAAI;gBAAEG,SAASG,MAAMH,OAAO;gBAAED,SAASI,MAAMJ,OAAO;YAAC;QAAE,GAC9F;YAAED,QAAQK,MAAML,MAAM,IAAI;QAAI;IAElC;IAEA,IAAIK,OAAOF,SAAS,YAAY;QAC9B,OAAOG,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAM;gBACNG,SAAS;gBACTD,SAASI,MAAMI,MAAM,IAAIJ,MAAMK,MAAM;YACvC;QACF,GACA;YAAEV,QAAQ;QAAI;IAElB;IAEA,IAAIK,OAAON,SAAS,SAAS;QAC3B,OAAOO,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAM;gBACNG,SAAS;gBACTD,SAASI,MAAMM,IAAI;YACrB;QACF,GACA;YAAEX,QAAQ;QAAI;IAElB;IAEA,IAAIK,OAAON,SAAS,SAAS;QAC3B,OAAOO,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAM;gBACNG,SAAS;gBACTD,SAASI,MAAMM,IAAI;YACrB;QACF,GACA;YAAEX,QAAQ;QAAI;IAElB;IAEA,gIAAM,CAACK,KAAK,CAAC,uBAAuB;QAClCN,MAAMM,OAAON;QACbG,SAASG,OAAOH;IAClB;IACA,KAAK,IAAA,iKAAsB,EAACG,OAAO;QACjCO,MAAM;YAAEC,OAAO;QAA0B;IAC3C;IAEA,wCAA2C;QACzC,OAAOP,SAASC,IAAI,CAClB;YACEC,SAAS;YACTH,OAAO;gBACLN,MAAMM,OAAON,QAAQ;gBACrBG,SAASG,OAAOH,WAAW;gBAC3BD,SAASI,OAAOS,SAAST;YAC3B;QACF,GACA;YAAEL,QAAQ;QAAI;IAElB;;;AAMF"}},
    {"offset": {"line": 236, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/permissions.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { AppError } from './errors';\r\n\r\nexport type FarmPermission =\r\n  | 'finance:read'\r\n  | 'finance:write'\r\n  | 'finance:approve'\r\n  | 'updates:read'\r\n  | 'updates:write'\r\n  | 'digest:read'\r\n  | 'monitoring:read'\r\n  | 'monitoring:write'\r\n  | 'incident:read'\r\n  | 'incident:write'\r\n  | 'vendor:read'\r\n  | 'vendor:write'\r\n  | 'procurement:read'\r\n  | 'procurement:write'\r\n  | 'payroll:read'\r\n  | 'payroll:write'\r\n  | 'payroll:approve'\r\n  | 'payroll:pay';\r\n\r\ntype FarmRole = 'OWNER' | 'MANAGER' | 'WORKER';\r\n\r\nconst roleMatrix: Record<FarmRole, FarmPermission[]> = {\r\n  OWNER: [\r\n    'finance:read',\r\n    'finance:write',\r\n    'finance:approve',\r\n    'updates:read',\r\n    'updates:write',\r\n    'digest:read',\r\n    'monitoring:read',\r\n    'monitoring:write',\r\n    'incident:read',\r\n    'incident:write',\r\n    'vendor:read',\r\n    'vendor:write',\r\n    'procurement:read',\r\n    'procurement:write',\r\n    'payroll:read',\r\n    'payroll:write',\r\n    'payroll:approve',\r\n    'payroll:pay',\r\n  ],\r\n  MANAGER: [\r\n    'finance:read',\r\n    'finance:write',\r\n    'updates:read',\r\n    'updates:write',\r\n    'digest:read',\r\n    'monitoring:read',\r\n    'monitoring:write',\r\n    'incident:read',\r\n    'incident:write',\r\n    'vendor:read',\r\n    'vendor:write',\r\n    'procurement:read',\r\n    'procurement:write',\r\n    'payroll:read',\r\n    'payroll:write',\r\n  ],\r\n  WORKER: ['updates:read', 'updates:write', 'incident:read', 'incident:write', 'procurement:read'],\r\n};\r\n\r\nexport function getRequestRole(request: NextRequest): FarmRole {\r\n  const headerRole = request.headers.get('x-farm-role');\r\n  if (headerRole === 'OWNER' || headerRole === 'MANAGER' || headerRole === 'WORKER') {\r\n    return headerRole;\r\n  }\r\n\r\n  return 'MANAGER';\r\n}\r\n\r\nexport function getRequestUserId(request: NextRequest): string {\r\n  return request.headers.get('x-user-id') || 'user_id_from_session';\r\n}\r\n\r\nexport function requirePermission(request: NextRequest, permission: FarmPermission) {\r\n  const role = getRequestRole(request);\r\n  if (!roleMatrix[role].includes(permission)) {\r\n    throw new AppError('FORBIDDEN', 'You do not have permission for this action', 403);\r\n  }\r\n}\r\n"],"names":["roleMatrix","OWNER","MANAGER","WORKER","getRequestRole","request","headerRole","headers","get","getRequestUserId","requirePermission","permission","role","includes"],"mappings":";;;;;;;;AACA;;AAwBA,MAAMA,aAAiD;IACrDC,OAAO;QACL;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACDC,SAAS;QACP;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACDC,QAAQ;QAAC;QAAgB;QAAiB;QAAiB;QAAkB;KAAmB;AAClG;AAEO,SAASC,eAAeC,OAAoB;IACjD,MAAMC,aAAaD,QAAQE,OAAO,CAACC,GAAG,CAAC;IACvC,IAAIF,eAAe,WAAWA,eAAe,aAAaA,eAAe,UAAU;QACjF,OAAOA;IACT;IAEA,OAAO;AACT;AAEO,SAASG,iBAAiBJ,OAAoB;IACnD,OAAOA,QAAQE,OAAO,CAACC,GAAG,CAAC,gBAAgB;AAC7C;AAEO,SAASE,kBAAkBL,OAAoB,EAAEM,UAA0B;IAChF,MAAMC,OAAOR,eAAeC;IAC5B,IAAI,CAACL,UAAU,CAACY,KAAK,CAACC,QAAQ,CAACF,aAAa;QAC1C,MAAM,IAAI,kIAAQ,CAAC,aAAa,8CAA8C;IAChF;AACF"}},
    {"offset": {"line": 312, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\n\r\nconst globalForPrisma = globalThis as unknown as { prisma: PrismaClient };\r\n\r\nexport const prisma = globalForPrisma.prisma || new PrismaClient();\r\n\r\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\r\n"],"names":["globalForPrisma","globalThis","prisma"],"mappings":";;;;AAAA;;AAEA,MAAMA,kBAAkBC;AAEjB,MAAMC,SAASF,gBAAgBE,MAAM,IAAI,IAAI,sMAAY;AAEhE,wCAA2CF,gBAAgBE,MAAM,GAAGA"}},
    {"offset": {"line": 325, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/services/procurement/procurement-service.ts"],"sourcesContent":["import { prisma } from '@/lib/prisma';\r\nimport { AppError } from '@/lib/errors';\r\n\r\ntype PurchaseOrderItemInput = {\r\n  description: string;\r\n  qty: number;\r\n  unitPrice: number;\r\n};\r\n\r\nexport class ProcurementService {\r\n  async requestPurchase(input: {\r\n    farmId: string;\r\n    userId: string;\r\n    reason: string;\r\n    vendorId?: string;\r\n    amount: number;\r\n    idempotencyKey: string;\r\n  }) {\r\n    const existing = await prisma.event.findUnique({\r\n      where: {\r\n        farmId_idempotencyKey: {\r\n          farmId: input.farmId,\r\n          idempotencyKey: input.idempotencyKey,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (existing) {\r\n      return { requestId: existing.id, reused: true };\r\n    }\r\n\r\n    const created = await prisma.event.create({\r\n      data: {\r\n        farmId: input.farmId,\r\n        type: 'PURCHASE_REQUESTED',\r\n        payload: {\r\n          reason: input.reason,\r\n          vendorId: input.vendorId,\r\n          amount: input.amount,\r\n        },\r\n        idempotencyKey: input.idempotencyKey,\r\n        userId: input.userId,\r\n      },\r\n    });\r\n\r\n    return { requestId: created.id, status: 'PENDING_REVIEW' };\r\n  }\r\n\r\n  async listPurchaseRequests(farmId: string) {\r\n    const requests = await prisma.event.findMany({\r\n      where: {\r\n        farmId,\r\n        type: 'PURCHASE_REQUESTED',\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: 50,\r\n    });\r\n\r\n    return requests;\r\n  }\r\n\r\n  async createPurchaseOrder(input: {\r\n    farmId: string;\r\n    vendorId: string;\r\n    items: PurchaseOrderItemInput[];\r\n    userId: string;\r\n    idempotencyKey: string;\r\n  }) {\r\n    const existingEvent = await prisma.event.findUnique({\r\n      where: {\r\n        farmId_idempotencyKey: {\r\n          farmId: input.farmId,\r\n          idempotencyKey: input.idempotencyKey,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (existingEvent) {\r\n      return { reused: true, idempotencyKey: input.idempotencyKey };\r\n    }\r\n\r\n    const vendor = await prisma.vendor.findFirst({\r\n      where: { id: input.vendorId, farmId: input.farmId },\r\n    });\r\n\r\n    if (!vendor) {\r\n      throw new AppError('VENDOR_NOT_FOUND', 'Vendor not found for this farm', 404);\r\n    }\r\n\r\n    const po = await prisma.$transaction(async (tx: any) => {\r\n      const created = await tx.purchaseOrder.create({\r\n        data: {\r\n          farmId: input.farmId,\r\n          vendorId: input.vendorId,\r\n          status: 'ISSUED',\r\n          items: {\r\n            create: input.items.map((item) => ({\r\n              description: item.description,\r\n              qty: item.qty,\r\n              unitPrice: item.unitPrice,\r\n            })),\r\n          },\r\n        },\r\n        include: { items: true },\r\n      });\r\n\r\n      await tx.event.create({\r\n        data: {\r\n          farmId: input.farmId,\r\n          type: 'PO_CREATED',\r\n          payload: {\r\n            poId: created.id,\r\n            vendorId: input.vendorId,\r\n            itemCount: input.items.length,\r\n          },\r\n          idempotencyKey: input.idempotencyKey,\r\n          userId: input.userId,\r\n        },\r\n      });\r\n\r\n      return created;\r\n    }, { isolationLevel: 'Serializable' });\r\n\r\n    return po;\r\n  }\r\n\r\n  async listPurchaseOrders(farmId: string) {\r\n    return prisma.purchaseOrder.findMany({\r\n      where: { farmId },\r\n      include: {\r\n        items: true,\r\n        vendor: true,\r\n        reconciliation: true,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: 50,\r\n    });\r\n  }\r\n\r\n  async confirmDelivery(input: {\r\n    farmId: string;\r\n    poId: string;\r\n    items: Array<{ itemId: string; qty: number }>;\r\n    userId: string;\r\n    discrepancyNote?: string;\r\n    idempotencyKey: string;\r\n  }) {\r\n    const existingEvent = await prisma.event.findUnique({\r\n      where: {\r\n        farmId_idempotencyKey: {\r\n          farmId: input.farmId,\r\n          idempotencyKey: input.idempotencyKey,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (existingEvent) {\r\n      return { reused: true };\r\n    }\r\n\r\n    const po = await prisma.purchaseOrder.findFirst({\r\n      where: { id: input.poId, farmId: input.farmId },\r\n    });\r\n\r\n    if (!po) {\r\n      throw new AppError('PO_NOT_FOUND', 'Purchase order not found', 404);\r\n    }\r\n\r\n    const result = await prisma.$transaction(async (tx: any) => {\r\n      for (const deliveryItem of input.items) {\r\n        await tx.inventoryItem.update({\r\n          where: { id: deliveryItem.itemId },\r\n          data: { balance: { increment: deliveryItem.qty } },\r\n        });\r\n\r\n        await tx.inventoryMovement.create({\r\n          data: {\r\n            itemId: deliveryItem.itemId,\r\n            qty: deliveryItem.qty,\r\n            type: 'PROCUREMENT',\r\n          },\r\n        });\r\n      }\r\n\r\n      await tx.purchaseOrder.update({\r\n        where: { id: input.poId },\r\n        data: { status: 'DELIVERED' },\r\n      });\r\n\r\n      if (input.discrepancyNote) {\r\n        await tx.pOReconciliation.upsert({\r\n          where: { poId: input.poId },\r\n          create: {\r\n            poId: input.poId,\r\n            status: 'DISCREPANCY',\r\n            diffs: { note: input.discrepancyNote },\r\n          },\r\n          update: {\r\n            status: 'DISCREPANCY',\r\n            diffs: { note: input.discrepancyNote },\r\n          },\r\n        });\r\n      }\r\n\r\n      await tx.event.create({\r\n        data: {\r\n          farmId: input.farmId,\r\n          type: 'PO_DELIVERED',\r\n          payload: {\r\n            poId: input.poId,\r\n            discrepancy: Boolean(input.discrepancyNote),\r\n          },\r\n          idempotencyKey: input.idempotencyKey,\r\n          userId: input.userId,\r\n        },\r\n      });\r\n\r\n      return { poId: input.poId, status: 'DELIVERED' };\r\n    }, { isolationLevel: 'Serializable' });\r\n\r\n    return result;\r\n  }\r\n}\r\n\r\nexport const procurementService = new ProcurementService();\r\n"],"names":["ProcurementService","requestPurchase","input","existing","event","findUnique","where","farmId_idempotencyKey","farmId","idempotencyKey","requestId","id","reused","created","create","data","type","payload","reason","vendorId","amount","userId","status","listPurchaseRequests","requests","findMany","orderBy","createdAt","take","createPurchaseOrder","existingEvent","vendor","findFirst","po","$transaction","tx","purchaseOrder","items","map","item","description","qty","unitPrice","include","poId","itemCount","length","isolationLevel","listPurchaseOrders","reconciliation","confirmDelivery","result","deliveryItem","inventoryItem","update","itemId","balance","increment","inventoryMovement","discrepancyNote","pOReconciliation","upsert","diffs","note","discrepancy","Boolean","procurementService"],"mappings":"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"}},
    {"offset": {"line": 557, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Desktop/farm_hands/src/app/api/farms/%5BfarmId%5D/procurement/orders/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { z } from 'zod';\r\nimport { createErrorResponse } from '@/lib/errors';\r\nimport { getRequestUserId, requirePermission } from '@/lib/permissions';\r\nimport { procurementService } from '@/services/procurement/procurement-service';\r\n\r\nconst createOrderSchema = z.object({\r\n  vendorId: z.string().min(1),\r\n  idempotencyKey: z.string().min(8),\r\n  items: z.array(z.object({\r\n    description: z.string().min(2),\r\n    qty: z.number().positive(),\r\n    unitPrice: z.number().positive(),\r\n  })).min(1).max(20),\r\n});\r\n\r\nexport async function GET(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ farmId: string }> }\r\n) {\r\n  try {\r\n    requirePermission(request, 'procurement:read');\r\n    const { farmId } = await context.params;\r\n    const data = await procurementService.listPurchaseOrders(farmId);\r\n    return Response.json({ success: true, data });\r\n  } catch (error) {\r\n    return createErrorResponse(error);\r\n  }\r\n}\r\n\r\nexport async function POST(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ farmId: string }> }\r\n) {\r\n  try {\r\n    requirePermission(request, 'procurement:write');\r\n    const { farmId } = await context.params;\r\n    const body = await request.json();\r\n    const input = createOrderSchema.parse(body);\r\n    const userId = getRequestUserId(request);\r\n\r\n    const data = await procurementService.createPurchaseOrder({\r\n      farmId,\r\n      userId,\r\n      ...input,\r\n    });\r\n\r\n    return Response.json({ success: true, data });\r\n  } catch (error) {\r\n    return createErrorResponse(error);\r\n  }\r\n}\r\n"],"names":["createOrderSchema","object","vendorId","string","min","idempotencyKey","items","array","description","qty","number","positive","unitPrice","max","GET","request","context","farmId","params","data","listPurchaseOrders","Response","json","success","error","POST","body","input","parse","userId","createPurchaseOrder"],"mappings":";;;;;;AACA;AACA;AACA;AACA;;;;;AAEA,MAAMA,oBAAoB,yKAAC,CAACC,MAAM,CAAC;IACjCC,UAAU,yKAAC,CAACC,MAAM,GAAGC,GAAG,CAAC;IACzBC,gBAAgB,yKAAC,CAACF,MAAM,GAAGC,GAAG,CAAC;IAC/BE,OAAO,yKAAC,CAACC,KAAK,CAAC,yKAAC,CAACN,MAAM,CAAC;QACtBO,aAAa,yKAAC,CAACL,MAAM,GAAGC,GAAG,CAAC;QAC5BK,KAAK,yKAAC,CAACC,MAAM,GAAGC,QAAQ;QACxBC,WAAW,yKAAC,CAACF,MAAM,GAAGC,QAAQ;IAChC,IAAIP,GAAG,CAAC,GAAGS,GAAG,CAAC;AACjB;AAEO,eAAeC,IACpBC,OAAoB,EACpBC,OAAgD;IAEhD,IAAI;QACF,IAAA,gJAAiB,EAACD,SAAS;QAC3B,MAAM,EAAEE,MAAM,EAAE,GAAG,MAAMD,QAAQE,MAAM;QACvC,MAAMC,OAAO,MAAM,gLAAkB,CAACC,kBAAkB,CAACH;QACzD,OAAOI,SAASC,IAAI,CAAC;YAAEC,SAAS;YAAMJ;QAAK;IAC7C,EAAE,OAAOK,OAAO;QACd,OAAO,IAAA,6IAAmB,EAACA;IAC7B;AACF;AAEO,eAAeC,KACpBV,OAAoB,EACpBC,OAAgD;IAEhD,IAAI;QACF,IAAA,gJAAiB,EAACD,SAAS;QAC3B,MAAM,EAAEE,MAAM,EAAE,GAAG,MAAMD,QAAQE,MAAM;QACvC,MAAMQ,OAAO,MAAMX,QAAQO,IAAI;QAC/B,MAAMK,QAAQ3B,kBAAkB4B,KAAK,CAACF;QACtC,MAAMG,SAAS,IAAA,+IAAgB,EAACd;QAEhC,MAAMI,OAAO,MAAM,gLAAkB,CAACW,mBAAmB,CAAC;YACxDb;YACAY;YACA,GAAGF,KAAK;QACV;QAEA,OAAON,SAASC,IAAI,CAAC;YAAEC,SAAS;YAAMJ;QAAK;IAC7C,EAAE,OAAOK,OAAO;QACd,OAAO,IAAA,6IAAmB,EAACA;IAC7B;AACF"}}]
}